CONCEPT ShapeSpace {
  PARAMETERS {
    d : Nat -- Ambient dimension
    ğ•œ : Field -- Coefficient field
  }

  CONTEXT {
    TYPES {
      Shape := CS(â„^d)
      DIR := ğ•Š^(d-1)
      Cover := {U_i â†ª M}
      MPD := Multiset(Î”)
      Î” := {(b, d) | b â‰¤ d}
    }
    
    STRUCTURES {
      STRUCTURE PHT {
        FIELD Z_M â‰” {(x,v,t) âˆˆ M Ã— DIR Ã— â„ | âŸ¨x, vâŸ© â‰¤ t}
        FIELD f_M : Z_M -> DIR Ã— â„
        FIELD PHT_M := R(f_M)_*ğ•œ_Z_M IN D^b(Shv(DIR Ã— â„))
        FIELD PHT^i_M := H^i(PHT_M) IN Shv(DIR Ã— â„)
        FIELD Dgm_M(i, v) -> MPD
          WHERE âˆƒ p : â„ -> MPD . Dgm_M(i, v) = p(v) AND p = Dgm(PHT^i_M|_{v}Ã—â„)
        AXIOM Naturality(f : M -> N) {
          f^*(Z_N) âŠ† Z_M
          f^*(PHT_N) â‰ƒ PHT_M  
        }
      }
      
      STRUCTURE LS EXTENDS PHT {
        FIELD ECT_M(v, t) := Ï‡(f^(-1)_M(v, t))
        FIELD BCT_M(v, t) := [Î²_i(f^(-1)_M(v, t))]_i
        AXIOM ECT_BCT: ECT_M(v, t) = <BCT_M(v, t), 1>
      }
      
      STRUCTURE Met {
        FIELD d : Shape Ã— Shape -> â„â‰¥0
        AXIOM âˆ€ M N. M â‰ƒ N => d(M,N) = 0
        AXIOM âˆ€ M N O. d(M,O) â‰¤ d(M,N) + d(N,O)
      }
    }
    
    ASSERTIONS {
      AXIOM isManifold(M : Shape) => LS(M)
      AXIOM Descent(M : Shape, ğ“¤ : Cover) 
        PHT_M â‰ƒ holim[ âˆ PHT_U -> âˆ PHT_{U âˆ© V} â‡‰ âˆ PHT_{U âˆ© V âˆ© W} â‹¯ ] 
                         U         U,V             U,V,W            
    }
    
    NOTATION {
      âŸ¨_, _âŸ© := InnerProduct
      Shv := Shv(DIR Ã— â„, ğ•œ)
      D^b := D^b(Shv)
      "_|_A" := Restrict(_, A)
      â‰ƒ := WeakEquivalence  
      âˆ« := Integral
      Ï‡ := EulerCharacteristic
      Î²_i := BettiNumber(_, i)
      R := DerivedDirectImage
      H^i := CohomologyFunctor(_, i)
    }
  }

  TRANSFORMERS {
    REWRITE IntervalDecomp(M : Shape) {
      Dgm_M(i, v) = âˆ_{I âˆˆ Ï€â‚€(BCT_M(v, ?))} GenDgm(Î²_i(M_I))
        WHERE M_I := Sublevel(M, âŸ¨v, ?âŸ©, I)
    }
    
    SIMPLIFY PartialI(i, v, t : â„ | d(v, v') < Îµ AND |t-t'| < Îµ) -> â„â‰¥0 {
      |Î²_i(f^(-1)_M(v, t)) - Î²_i(f^(-1)_M(v', t'))| <= Î²áµ€_i(f^(-1)_M(vÃ—[t-Îµ,t+Îµ])) 
    }
    
    REWRITE InterpolatedPHT(M, i, v, t, Îµ) -> D^b {
      LET F := Fun(p â†¦ Î£_{|v'-v|<Îµ} (Res(PHT^i_M, v' Ã— {p}) -> ğ•œ), {t-Îµâ‰¤pâ‰¤t+Îµ})
      IN RÎ“_c(F(?) -> ğ•œ)
    }
  }
  
  PROOFS {
    THEOREM Stability(ğ““ : Met) âˆ€ M N . dI(PHT_M, PHT_N) â‰¤ ğ““(M, N) {
      dI(PHT_M, PHT_N) 
        â‰¤ inf {Îµ | âˆƒ (f : M â‰ƒ_Îµ N) . PHT_f : PHT_M =[Îµ]= PHT_N} -- Interpolation
        â‰¤ inf {Îµ | âˆƒ (f : M â‰ƒ_Îµ N)} -- Stability of persistent homology
        = ğ““(M, N) -- By Met
      QED
    }
    
    THEOREM Approx âˆ€ (M : Shape, Ï„ : â„>0, Îµ Î´ : â„>0)
      Îµ < Ï„/4 âˆ§ Prob_{X~ğ’°(M)} [Xáµ‰ âŠ† M âŠ† X^{âˆš(2)Îµ} | |X| = O((1/Îµ)^d)] > 1-Î´
      => âˆƒ K. Prob[dI(PHT_M, PHT_K) â‰¤ CÎµ] > 1-Î´ {
      GIVEN M : Shape, Ï„ : â„>0, Îµ Î´ : â„>0 
        WHERE Îµ < Ï„/4 âˆ§ Prob_{X~ğ’°(M)} [Xáµ‰ âŠ† M âŠ† X^{âˆš(2)Îµ} | |X| = O((1/Îµ)^d)] > 1-Î´

      X â‰” SAMPLE_(x âˆˆ M) |X| = O((1/Îµ)^d) 
      LET U_x â‰” Ball(x, Îµ) âˆ€ x âˆˆ X
      LET K â‰” NerveComplex({U_x}_x)

      HAVE M â‰ƒ â‹ƒ U_x w.p. > 1-Î´ -- Cech approximation 
      HAVE â‹ƒ U_x â‰ƒ K -- Nerve theorem
      HENCE M â‰ƒ K w.p. > 1-Î´

      Máµ‰ âŠ† M âŠ† M^{âˆš(2)Îµ} => dI(PHT_M, PHT_K) â‰¤ âˆš(2)Îµ w.p. > 1-Î´ -- Sandwich theorem
      TAKE C := âˆš2  
      QED
    }

    THEOREM PHTDeterminesShape âˆ€ M N : Shape . PHT_M â‰ƒ PHT_N => M â‰ƒ N {
      PHT_M â‰ƒ PHT_N 
      => âˆ€ i. PHT^i_M â‰ƒ PHT^i_N -- By definition
      => BCT_M(v,t) = BCT_N(v,t) âˆ€ v t -- By definition
      => ECT_M(v,t) = ECT_N(v,t) âˆ€ v t -- By LS.ECT_BCT
      => M â‰ƒ N -- By CurrySchapira
      QED
    }
    
    THEOREM PHTDescentTheorem âˆ€ (M : Shape, ğ“¤ : Cover | FiniteCover(ğ“¤, M)) . 
      PHT_M â‰ƒ holim[ âˆ PHT_U -> âˆ PHT_{U âˆ© V} â‡‰ âˆ PHT_{U âˆ© V âˆ© W} â‹¯ ] {
      
      SUFFICES_TO_SHOW PHT_M -> holim[â‹¯] is a quasi-isomorphism
      
      DEFINE ğ“–_â€¢ := GodementResolution(ğ•œ_Z_M)
      
      HAVE R(f_M)_*(ğ“–_â€¢) is a quasi-isomorphism:
        PHT_M â‰ƒ R(f_M)_* ğ•œ_Z_M -- By definition
              â‰ƒ R(f_M)_* holim(ğ“–_â€¢) -- By ğ“–_â€¢ is a resolution 
              â‰ƒ holim R(f_M)_*(ğ“–_â€¢) -- By R âŠ£ holim
              â‰ƒ holim[â‹¯] -- By Cech
              
      HAVE R(f_M)_*(ğ“–_â€¢) is a q.i. on stalks âˆ€ v t:
        H^*(PHT_M_(v,t)) â‰ƒ H^*(f^(-1)_M(v, t)) -- By definition 
                         â‰ƒ H^*(holim(ğ“–_â€¢)_(v,t)) -- By ğ“–_â€¢ is a resolution
                         â‰ƒ H^*(holim[â‹¯]_(v,t)) -- By Cech
                         
      QED
    }
  }
  
  EXAMPLES {
    EXAMPLE Sphere(d, n) WHERE S^d_n â‰” {x âˆˆ â„^(d+1) | â€–xâ€– = 1 âˆ§ âˆ€i>n. x_i=0} {
      Dgm(S^d_n) = [
        [],
        [(0,âˆ)],
        [],
        ...,
        [(0,âˆ)] IF d=n, [] o.w.
      ]
    }
    
    EXAMPLE KleinBottle {
      Z := Z_ğ•‚Â² = {((x,y,z,w), (v,t)) | x^2v_1 + y^2(v_2 - 2zv_1) + zw = t} âŠ† â„â´ Ã— (ğ•ŠÂ² Ã— â„)
      Dgm(ğ•‚Â²) = [
        [],
        [(0,âˆ), (0,âˆ)],
        [],
        [(0,âˆ)]  
      ]
    }
    
    EXAMPLE Torus {
      Z := Z_ğ•‹Â² = {((Î¸,Ï†), (v,t)) | (R+rÂ·cosÎ¸)Â·cosÏ†Â·v_1 + (R+rÂ·cosÎ¸)Â·sin Ï†Â·v_2 + rÂ·sinÎ¸Â·v_3 = t}
      Dgm(ğ•‹Â²) = [
        [],  
        [(0,âˆ), (0,âˆ)],
        [(0,âˆ)],
        []
      ]
    }
  }
}