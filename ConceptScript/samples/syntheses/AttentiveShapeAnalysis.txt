CONCEPT AttentiveShapeAnalysis {
  PARAMETERS {
    d : Nat -- Ambient dimension
    ùïú : Field -- Coefficient field
    h : Nat -- Number of attention heads
  }

  CONTEXT {
    TYPES {
      Shape := CS(‚Ñù^d)
      DIR := ùïä^(d-1)
      Cover := {U_i ‚Ü™ M}
      MPD := Multiset(Œî)
      Œî := {(b, d) | b ‚â§ d}
      Seq(T) := FUNC(Fin(N), T)
      ShapeFeature := ‚Ñù^m -- m-dimensional feature vector
    }
    
    STRUCTURES {
      STRUCTURE APHT EXTENDS PHT {
        FIELD f_M : Z_M -> DIR √ó ‚Ñù √ó ShapeFeature
        FIELD APHT_M := R(f_M)_*ùïú_Z_M IN D^b(Shv(DIR √ó ‚Ñù √ó ShapeFeature))
        FIELD APHT^i_M := H^i(APHT_M) IN Shv(DIR √ó ‚Ñù √ó ShapeFeature)
        FIELD Dgm_M(i, v, feat) -> MPD
          WHERE ‚àÉ p : ‚Ñù √ó ShapeFeature -> MPD . 
            Dgm_M(i, v, feat) = p(v, feat) AND 
            p = Dgm(APHT^i_M|_{v}√ó‚Ñù√ó{feat})
      }
      
      STRUCTURE AttentiveLS EXTENDS APHT, LS {
        FIELD AttentionMechanism : Attention(ShapeFeature, ShapeFeature, MPD)
        FIELD AECT_M(v, t, feat) := AttentionMechanism(
          feat,
          Seq(f_M(x, v', t') for (x, v', t') in Z_M),
          Seq(ECT_M(v', t') for (x, v', t') in Z_M)
        )
        FIELD ABCT_M(v, t, feat) := AttentionMechanism(
          feat,
          Seq(f_M(x, v', t') for (x, v', t') in Z_M),
          Seq(BCT_M(v', t') for (x, v', t') in Z_M)
        )
        AXIOM AECT_ABCT: AECT_M(v, t, feat) = <ABCT_M(v, t, feat), 1>
      }
      
      STRUCTURE AttentiveMet EXTENDS Met {
        FIELD AttentionMechanism : Attention(ShapeFeature, ShapeFeature, ‚Ñù‚â•0)
        OVERRIDE d(M : Shape, N : Shape) := AttentionMechanism(
          GlobalFeature(M),
          Seq(LocalFeature(x) for x in SamplePoints(M)),
          Seq(LocalDistance(x, N) for x in SamplePoints(M))
        )
        AXIOM AttentiveMetricProperties {
          ‚àÄ M N. M ‚âÉ N => d(M,N) = 0
          ‚àÄ M N O. d(M,O) ‚â§ d(M,N) + d(N,O)
        }
      }
    }
    
    ASSERTIONS {
      AXIOM isManifold(M : Shape) => AttentiveLS(M)
      AXIOM AttentiveDescent(M : Shape, ùì§ : Cover) 
        APHT_M ‚âÉ holim[ ‚àè APHT_U -> ‚àè APHT_{U ‚à© V} ‚áâ ‚àè APHT_{U ‚à© V ‚à© W} ‚ãØ ] 
                           U           U,V               U,V,W            
    }
    
    NOTATION {
      ‚ü®_, _‚ü© := InnerProduct
      Shv := Shv(DIR √ó ‚Ñù √ó ShapeFeature, ùïú)
      D^b := D^b(Shv)
      "_|_A" := Restrict(_, A)
      ‚âÉ := WeakEquivalence  
      ‚à´ := Integral
      œá := EulerCharacteristic
      Œ≤_i := BettiNumber(_, i)
      R := DerivedDirectImage
      H^i := CohomologyFunctor(_, i)
    }
  }

  TRANSFORMERS {
    REWRITE AttentiveIntervalDecomp(M : Shape) {
      Dgm_M(i, v, feat) = AttentionMechanism(
        feat,
        Seq(LocalFeature(I) for I in œÄ‚ÇÄ(ABCT_M(v, ?))),
        Seq(GenDgm(Œ≤_i(M_I)) for I in œÄ‚ÇÄ(ABCT_M(v, ?)))
      )
        WHERE M_I := Sublevel(M, ‚ü®v, ?‚ü©, I)
    }
    
    SIMPLIFY AttentivePartialI(i, v, t : ‚Ñù, feat : ShapeFeature | d(v, v') < Œµ AND |t-t'| < Œµ AND ‚Äñfeat - feat'‚Äñ < Œ¥) -> ‚Ñù‚â•0 {
      ‚ÄñABCT_M(v, t, feat) - ABCT_M(v', t', feat')‚Äñ ‚â§ 
        AttentionMechanism(
          feat,
          Seq(LocalFeature(x) for x in f^(-1)_M(v√ó[t-Œµ,t+Œµ]√óB(feat,Œ¥))),
          Seq(Œ≤·µÄ_i(f^(-1)_M(v√ó[t-Œµ,t+Œµ]√óB(feat,Œ¥))) for x in f^(-1)_M(v√ó[t-Œµ,t+Œµ]√óB(feat,Œ¥)))
        )
    }
    
    REWRITE AttentiveInterpolatedPHT(M, i, v, t, feat, Œµ, Œ¥) -> D^b {
      LET F := Fun(
        (p, f) ‚Ü¶ AttentionMechanism(
          f,
          Seq(LocalFeature(x) for x in {x | |v'-v|<Œµ, |f'-f|<Œ¥}),
          Seq(Res(APHT^i_M, v' √ó {p} √ó {f'}) -> ùïú for v',f' in {x | |v'-v|<Œµ, |f'-f|<Œ¥})
        ),
        {t-Œµ‚â§p‚â§t+Œµ, ‚Äñf-feat‚Äñ‚â§Œ¥}
      )
      IN RŒì_c(F(?, ?) -> ùïú)
    }
  }

  PROOFS {
    THEOREM AttentiveStability(ùìì : AttentiveMet) ‚àÄ M N . dI(APHT_M, APHT_N) ‚â§ ùìì(M, N) {
      dI(APHT_M, APHT_N) 
        ‚â§ inf {Œµ | ‚àÉ (f : M ‚âÉ_Œµ N) . APHT_f : APHT_M =[Œµ]= APHT_N} -- Interpolation
        ‚â§ inf {Œµ | ‚àÉ (f : M ‚âÉ_Œµ N)} -- Stability of persistent homology
        = ùìì(M, N) -- By AttentiveMet
      QED
    }
    
    THEOREM AttentiveApprox ‚àÄ (M : Shape, œÑ : ‚Ñù>0, Œµ Œ¥ : ‚Ñù>0)
      Œµ < œÑ/4 ‚àß Prob_{X~ùí∞(M)} [X·µâ ‚äÜ M ‚äÜ X^{‚àö(2)Œµ} | |X| = O((1/Œµ)^d)] > 1-Œ¥
      => ‚àÉ K. Prob[dI(APHT_M, APHT_K) ‚â§ CŒµ] > 1-Œ¥ {
      GIVEN M : Shape, œÑ : ‚Ñù>0, Œµ Œ¥ : ‚Ñù>0 
        WHERE Œµ < œÑ/4 ‚àß Prob_{X~ùí∞(M)} [X·µâ ‚äÜ M ‚äÜ X^{‚àö(2)Œµ} | |X| = O((1/Œµ)^d)] > 1-Œ¥

      X ‚âî SAMPLE_(x ‚àà M) |X| = O((1/Œµ)^d) 
      LET U_x ‚âî Ball(x, Œµ) ‚àÄ x ‚àà X
      LET K ‚âî NerveComplex({U_x}_x)

      HAVE M ‚âÉ ‚ãÉ U_x w.p. > 1-Œ¥ -- Cech approximation 
      HAVE ‚ãÉ U_x ‚âÉ K -- Nerve theorem
      HENCE M ‚âÉ K w.p. > 1-Œ¥

      M·µâ ‚äÜ M ‚äÜ M^{‚àö(2)Œµ} => dI(APHT_M, APHT_K) ‚â§ ‚àö(2)Œµ w.p. > 1-Œ¥ -- Sandwich theorem
      TAKE C := ‚àö2  
      QED
    }

    THEOREM APHTDeterminesShape ‚àÄ M N : Shape . APHT_M ‚âÉ APHT_N => M ‚âÉ N {
      APHT_M ‚âÉ APHT_N 
      => ‚àÄ i. APHT^i_M ‚âÉ APHT^i_N -- By definition
      => ABCT_M(v,t,feat) = ABCT_N(v,t,feat) ‚àÄ v t feat -- By definition
      => AECT_M(v,t,feat) = AECT_N(v,t,feat) ‚àÄ v t feat -- By AttentiveLS.AECT_ABCT
      => M ‚âÉ N -- By AttentiveCurrySchapira
      QED
    }
    
    THEOREM APHTDescentTheorem ‚àÄ (M : Shape, ùì§ : Cover | FiniteCover(ùì§, M)) . 
      APHT_M ‚âÉ holim[ ‚àè APHT_U -> ‚àè APHT_{U ‚à© V} ‚áâ ‚àè APHT_{U ‚à© V ‚à© W} ‚ãØ ] {
      
      SUFFICES_TO_SHOW APHT_M -> holim[‚ãØ] is a quasi-isomorphism
      
      DEFINE ùìñ_‚Ä¢ := GodementResolution(ùïú_Z_M)
      
      HAVE R(f_M)_*(ùìñ_‚Ä¢) is a quasi-isomorphism:
        APHT_M ‚âÉ R(f_M)_* ùïú_Z_M -- By definition
               ‚âÉ R(f_M)_* holim(ùìñ_‚Ä¢) -- By ùìñ_‚Ä¢ is a resolution 
               ‚âÉ holim R(f_M)_*(ùìñ_‚Ä¢) -- By R ‚ä£ holim
               ‚âÉ holim[‚ãØ] -- By Cech
              
      HAVE R(f_M)_*(ùìñ_‚Ä¢) is a q.i. on stalks ‚àÄ v t feat:
        H^*(APHT_M_(v,t,feat)) ‚âÉ H^*(f^(-1)_M(v, t, feat)) -- By definition 
                                ‚âÉ H^*(holim(ùìñ_‚Ä¢)_(v,t,feat)) -- By ùìñ_‚Ä¢ is a resolution
                                ‚âÉ H^*(holim[‚ãØ]_(v,t,feat)) -- By Cech
                         
      QED
    }

    THEOREM AttentionInvarianceAPHT {
      FORALL (M : Shape, U : Unitary(ShapeFeature)) .
        LET apht = APHT(M)
            apht' = apht WITH {
              f_M := Œª (x, v, t) . (v, t, U(LocalFeature(x))),
              AttentionMechanism := Œª q ks vs . 
                apht.AttentionMechanism(U^(-1)(q), Seq(U^(-1)(k) for k in ks), vs)
            }
        IN apht(v, t, feat) = apht'(v, t, U(feat))
    }
    PROOF {
      ASSUME M : Shape, U : Unitary(ShapeFeature)

      apht'(v, t, U(feat))
        = AttentionMechanism(
            U(feat),
            Seq(U(LocalFeature(x)) for x in f_M^(-1)(v, t, U(feat))),
            Seq(ECT_M(v', t') for (x, v', t') in f_M^(-1)(v, t, U(feat)))
          ) [BY DEF Apply, APHT]
        = apht.AttentionMechanism(
            feat,
            Seq(LocalFeature(x) for x in f_M^(-1)(v, t, feat)),
            Seq(ECT_M(v', t') for (x, v', t') in f_M^(-1)(v, t, feat))
          ) [BY DEF apht', AttentionMechanism, U Unitary]
        = apht(v, t, feat) [BY DEF Apply, APHT]
      QED
    }
  }

  EXAMPLES {
    EXAMPLE AttentiveSphere(d, n) WHERE S^d_n ‚âî {x ‚àà ‚Ñù^(d+1) | ‚Äñx‚Äñ = 1 ‚àß ‚àÄi>n. x_i=0} {
      LET feat(x) = [x_1, ..., x_(d+1), ‚Äñx‚Äñ_2, ‚Äñx‚Äñ_‚àû, SphericalHarmonic(x, 1), ..., SphericalHarmonic(x, 5)]
      
      APHT(S^d_n) = AttentionMechanism(
        GlobalFeature(S^d_n),
        Seq(feat(x) for x in SamplePoints(S^d_n)),
        [
          [],
          [(0,‚àû)],
          [],
          ...,
          [(0,‚àû)] IF d=n, [] o.w.
        ]
      )
    }
  }
}