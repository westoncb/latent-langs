CONCEPT PhysiomeModeling {
  IMPORT PhysiologicalNotation
  
  LANGUAGE {
    type Model = Graph(Node, Edge)
    type Node = (State, Dynamics)
    type Edge = (Coupling, Delay)
    type State = â„^n
    type Dynamics = State -> State
    type Coupling = (State, State) -> â„
    type Delay = â„â‚Š
    
    type Method = (Model, â„â‚Š) -> Model  ; Simulation method
    
    func euler(m: Model, dt: â„â‚Š): Model  ; Euler's method
      := (v, t) â†¦ v + dt * m.Dynamics(v)
    
    func rk4(m: Model, dt: â„â‚Š): Model  ; 4th-order Runge-Kutta
      := (v, t) â†¦ v + (kâ‚ + 2kâ‚‚ + 2kâ‚ƒ + kâ‚„) / 6
         where kâ‚ = dt * m.Dynamics(v)
               kâ‚‚ = dt * m.Dynamics(v + kâ‚/2)
               kâ‚ƒ = dt * m.Dynamics(v + kâ‚‚/2)
               kâ‚„ = dt * m.Dynamics(v + kâ‚ƒ)
               
    func backwardEuler(m: Model, dt: â„â‚Š): Model ; Backward Euler
      := (v, t) â†¦ ğ“ˆ such that ğ“ˆ = v + dt * m.Dynamics(ğ“ˆ)
      
    func symplecticEuler(m: Model, dt: â„â‚Š): Model  ; Symplectic Euler
      := (q, p, t) â†¦ (q + dt * âˆ‚H/âˆ‚p, p - dt * âˆ‚H/âˆ‚q) 
         where (q, p) is the state and H is the Hamiltonian
         
    func masterEq(m: Model): Model  ; Master equation for Markov model
      := âˆ‚â‚œP(t) = KÂ·P(t) where K is the transition matrix
      
    func gillespie(m: Model): â„ Ã— Model  ; Gillespie's stochastic simulation algorithm 
      := (Ï„, x + váµ¢) where i ~ P(i) = aáµ¢(x) / aâ‚€(x)
                       and Ï„ ~ Exp(aâ‚€(x))
                       
    func forwardKolmogorov(m: Model): Model  ; Forward Kolmogorov PDE for Markov model 
      := âˆ‚â‚œP(x,t) = âˆ‘áµ¢â±¼ [Káµ¢â±¼ Â· P(xáµ¢,t) - Kâ±¼áµ¢ Â· P(x,t)]
      
    func finiteDifference(m: Model, dx: â„â‚Š): Model  ; Finite difference discretization in space
      := (u, t, x) â†¦ [u(t,x+dx) - 2u(t,x) + u(t,x-dx)] / dxÂ²
      
    func finiteElement(m: Model, Î©: Mesh): Model ; Finite element discretization on mesh
      := âˆ«_Î© (âˆ‡u Â· âˆ‡v + uv) dx = âˆ«_Î© fv dx âˆ€ v âˆˆ V_h
         where V_h is the finite element space on Î©
         
    func imex(m: Model, dt: â„â‚Š): Model  ; Implicit-Explicit method
      := (v, t) â†¦ v + dt * [Explicit(v) + Implicit(v, t+dt)]
         where Explicit and Implicit are splitting terms
  }
  
  STRUCTURE {
    [ReactionDiffusion(U: B, V: B, f: B -> B, g: B -> B, D_u: â„â‚Š, D_v: â„â‚Š): Model
      â†¦ âˆ‚â‚œU = D_uÂ·Î”U + f(U,V), âˆ‚â‚œV = D_vÂ·Î”V + g(U,V)]
      
    [FitzHughNagumo(v: â„, w: â„, I: â„, a: â„, b: â„, c: â„): Model  
      â†¦ âˆ‚â‚œv = cÂ·(v - vÂ³/3 + w + I), âˆ‚â‚œw = -(v - a + bÂ·w) / c]
    
    [HodgkinHuxley(V: â„, m: â„, h: â„, n: â„, g_Na: â„â‚Š, g_K: â„â‚Š, g_L: â„â‚Š, E_Na: â„, E_K: â„, E_L: â„, C: â„â‚Š, I: â„): Model
      â†¦ CÂ·âˆ‚â‚œV = g_NaÂ·mÂ³Â·hÂ·(E_Na - V) + g_KÂ·nâ´Â·(E_K - V) + g_LÂ·(E_L - V) + I,  
        âˆ‚â‚œm = Î±_mÂ·(1 - m) - Î²_mÂ·m, âˆ‚â‚œh = Î±_hÂ·(1 - h) - Î²_hÂ·h, âˆ‚â‚œn = Î±_nÂ·(1 - n) - Î²_nÂ·n]  
        
    [CardiacElectrophysiology(V: â„, y: â„^n, I_ion: â„^k): Model
      â†¦ âˆ‚â‚œV = âˆ‡Â·(DÂ·âˆ‡V) - I_ionÂ·V / C_m, âˆ‚â‚œy = f(V, y)]
      
    [BloodFlowModel(v: C(t) -> â„Â³, p: C(t) -> â„, Ï: â„â‚Š, Î¼: â„â‚Š): Model  
      â†¦ ÏÂ·(âˆ‚â‚œv + vÂ·âˆ‡v) = -âˆ‡p + Î¼Â·Î”v, âˆ‡Â·v = 0]
      
    [CirculatorySystem(H: Model, A: Model, V: Model, C: Model, R: â„â‚Š, C: â„â‚Š): Model
      â†¦ Q = H.Output = CÂ·dP/dt, P_a - P_v = RÂ·Q
        where H, A, V, C are heart, arterial, venous, and capillary models]
        
    [RespiratoryMechanics(P: â„, V: â„, Q: â„, C: â„â‚Š, R: â„â‚Š, P_0: â„, V_0: â„): Model
      â†¦ P - P_0 = 1/CÂ·(V - V_0) + RÂ·Q, Q = dV/dt]
      
    [GasSolubility(c: B, p: â„, k: â„â‚Š): Model  ; Henry's law
      â†¦ p = kÂ·c]
      
    [GasExchange(V_A: â„, V_D: â„, Q: â„, c_i: â„, c_o: â„): Model  ; Ventilation-perfusion model
      â†¦ V_AÂ·dc_i/dt = QÂ·(c_o - c_i), V_DÂ·dc_o/dt = QÂ·(c_i - c_o)]
      
    [RenalTransport(C_i: â„, C_o: â„, J_s: â„, J_r: â„, T_m: â„â‚Š, K_m: â„â‚Š): Model  ; Michaelis-Menten kinetics 
      â†¦ J_s = T_mÂ·C_i / (K_m + C_i), J_r = T_mÂ·C_o / (K_m + C_o)]  
      
    [GlucoseInsulinModel(G: â„, I: â„, G_b: â„â‚Š, I_b: â„â‚Š): Model  ; Minimal model
      â†¦ dG/dt = -pâ‚Â·(G - G_b) - XÂ·G + D, dI/dt = -nÂ·(I - I_b) + Î³Â·(G - h)âº,
        dX/dt = -pâ‚‚Â·X + pâ‚ƒÂ·(I - I_b)]
        
    [ImmunologyModel(V: â„, T: â„, I: â„, Î²: â„â‚Š, Î³: â„â‚Š, k: â„â‚Š, Î»: â„â‚Š, Î¼_T: â„â‚Š, Î¼_I: â„â‚Š): Model  ; HIV model
      â†¦ dT/dt = Î» - Î¼_TÂ·T - Î²Â·VÂ·T, dI/dt = Î²Â·VÂ·T - Î¼_IÂ·I, dV/dt = kÂ·I - Î³Â·V]
      
    [TumorGrowthModel(N: â„, K: â„â‚Š, r: â„â‚Š): Model  ; Logistic growth
      â†¦ dN/dt = rÂ·NÂ·(1 - N/K)]
  }
  
  PROOFS {
    theorem FiniteDifferenceConvergence(u: Model, u_k: Model, k: â„•, h_k: â„â‚Š):
      (âˆ€ k. u_k = finiteDifference(u, h_k)) âˆ§ (h_k â‰¤ CÂ·h_{k-1}Â²) âˆ§ (u âˆˆ Câ´) 
      â‡’ âˆƒ Câ‚. âˆ€ k. âˆ¥u_k - uâˆ¥ â‰¤ Câ‚Â·h_kÂ²
    {
      assume (âˆ€ k. u_k = finiteDifference(u, h_k)), (h_k â‰¤ CÂ·h_{k-1}Â²), (u âˆˆ Câ´)
      
      let e_k := u_k - u, Ï„_j := jh_k for j = 1,...,k
      have e_k(0) = 0, e_k(1) = 0  ; boundary conditions
      
      let L := âˆ‡Â²  ; Laplacian operator
      have (I - h_kÂ²Â·L)e_k = -h_kÂ²Â·Ï„_k + O(h_kâ´)  ; by finite difference approximation
        where Ï„_k := (Lu(Ï„â‚),...,Lu(Ï„_k)), âˆ¥Ï„_kâˆ¥ â‰¤ âˆ¥uâˆ¥_Câ´  ; by Taylor's theorem
        
      let G_k := (I - h_kÂ²Â·L)â»Â¹  ; discrete Green's operator
      have âˆ¥G_kâˆ¥ â‰¤ âˆ¥(I - h_kÂ²Â·L)â»Â¹âˆ¥ â‰¤ Câ‚‚  ; uniform bound on Green's function
      
      have e_k = -h_kÂ²Â·G_kÂ·Ï„_k + G_kÂ·O(h_kâ´)
           â‡’ âˆ¥e_kâˆ¥ â‰¤ Ch_kÂ²âˆ¥Ï„_kâˆ¥ + Ch_kâ´ â‰¤ Câ‚h_kÂ²  ; by uniform bounds on G_k and Ï„_k
    }
    
    theorem StabilityOfSymplecticEuler(H: Model, x_k: State, k: â„•, dt: â„â‚Š):
      (âˆ€ k. x_{k+1} = symplecticEuler(H, x_k, dt)) âˆ§ (H is Lipschitz)
      â‡’ âˆƒ Câ‚, Câ‚‚, hâ‚€. (âˆ€ h < hâ‚€. âˆ€ n < â„¯^{Câ‚/h}. âˆ¥x_n - x(nÂ·h)âˆ¥ â‰¤ Câ‚‚Â·h)
    {
      assume (âˆ€ k. x_{k+1} = symplecticEuler(H, x_k, dt)), (H is Lipschitz)
      
      let L := âˆ‡H  ; Hamiltonian vector field 
      have âˆ¥Lâˆ¥ â‰¤ C  ; by Lipschitz condition on H
      
      let Ï•_t := exp(tL)  ; exact flow of L
      have Ï•_h = I + hL + hÂ²LÂ²/2 + O(hÂ³)  ; by Taylor expansion
      
      let Î¨_h := symplecticEuler(H, Â·, h) = (I + hJâ»Â¹L)(I + hJL)â»Â¹
        where J := [0 -I; I 0] is the symplectic matrix
      have (Î¨_h - Ï•_h)x = O(hÂ³)âˆ¥xâˆ¥  ; by matching Taylor expansions
      
      let n := t/h, x_h(t) := (Î¨_h)â¿Â·xâ‚€  ; numerical solution
      have x_h(t) - x(t) = âˆ‘â±¼ (Î¨_h - Ï•_h)Â·(Ï•_h)Ê²â»Â¹Â·x(jh)
         â‡’ âˆ¥x_h(t) - x(t)âˆ¥ â‰¤ nCâ‚ƒhÂ³âˆ¥xâ‚€âˆ¥  ; by telescoping sum and bounds on Î¨_h, Ï•_h
         â‡’ âˆ¥x_h(t) - x(t)âˆ¥ â‰¤ Câ‚‚Â·h  ; for n â‰¤ â„¯^{Câ‚/h} and hâ‚€ sufficiently small
    }
    
    theorem ErrorAnalysisOfImex(u: Model, u_k: Model, k: â„•, dt: â„â‚Š):  
      (âˆ€ k. u_{k+1} = imex(u_k, dt)) âˆ§ (Explicit, Implicit are Lipschitz) âˆ§ (u âˆˆ CÂ³)
      â‡’ âˆƒ C. âˆ€ k. âˆ¥u_k - u(kÂ·dt)âˆ¥ â‰¤ CÂ·dtÂ²
    {
      assume (âˆ€ k. u_{k+1} = imex(u_k, dt)), (Explicit, Implicit are Lipschitz), (u âˆˆ CÂ³)
      
      let F := Explicit, G := Implicit
      have âˆ¥Fâˆ¥, âˆ¥Gâˆ¥ â‰¤ C  ; by





// this one got cut shortâ€”ran out of tokens I think