CONCEPT ShapeSpace {
  LANGUAGE {
    TYPE Shape <: CS(R^d)
    TYPE Direction = S^(d-1)
    TYPE Filtration = R
    TYPE PersistenceDiagram = Dgm

    FUNC PHT[d : Nat](M : Shape) : Direction -> PersistenceDiagram^d
    FUNC PHTSheaf(M : Shape) : D^b(Shv(Direction * Filtration))
    FUNC InterleavingDist(F G : D^b(Shv(Direction * Filtration))) : R^â‰¥0
    FUNC ShiftFunctor[Îµ : R^â‰¥0](F : D^b(Shv(Direction * Filtration))) : D^b(Shv(Direction * Filtration))
    FUNC BottleneckDist(D E : PersistenceDiagram) : R^â‰¥0
    FUNC WassersteinDist[p : R^â‰¥1](D E : PersistenceDiagram) : R^â‰¥0
    
    PRED FiniteCover(U : List[Shape], M : Shape) = (â‹ƒ_{N âˆˆ U} N = M) âˆ§ Finite(U)
    PRED ÄŒechDescent(F : D^b(Shv(Direction * Filtration)), U : FiniteCover) =
      F(â‹ƒU) â‰ƒ holim[ âˆ_{N âˆˆ U} F(N) => âˆ_{N,N' âˆˆ U} F(N âˆ© N') -> ... ]
    PRED Îµ-Interleaving(F G : D^b(Shv(Direction * Filtration)), Îµ : R^â‰¥0) =
      âˆƒ (Ï† : ShiftFunctor[Îµ](F) -> G) (Ïˆ : ShiftFunctor[Îµ](G) -> F) .
        Ï† âˆ˜ ShiftFunctor[Îµ](Ïˆ) = ShiftFunctor[2Îµ](Ï_G) âˆ§ 
        Ïˆ âˆ˜ ShiftFunctor[Îµ](Ï†) = ShiftFunctor[2Îµ](Ï_F)
    PRED Îµ-Homotopic(M N : Shape, Îµ : R^â‰¥0) =
      âˆƒ (Ï† : M -> N) (Ïˆ : N -> M) .
        (âˆ€ m : M . |m - Ï†(m)| â‰¤ Îµ) âˆ§
        (âˆ€ n : N . |n - Ïˆ(n)| â‰¤ Îµ) âˆ§
        (Ï† âˆ˜ Ïˆ â‰ƒ Id_N) âˆ§ (Ïˆ âˆ˜ Ï† â‰ƒ Id_M)
        
    AXIOM PHTGluing {
      âˆ€ (M : Shape) (U : List[Shape]) . 
        FiniteCover(U, M) => ÄŒechDescent(PHTSheaf(M), U)
    }
    
    AXIOM PHTPolyhedronNerve {
      âˆ€ (M : Shape) (n : â„•) . IsPolyhedron(M) =>
        PHTSheaf(M)^n â‰ƒ H^n[
          0 -> âŠ•_{I âŠ‚ ğ•€, |I|=1} PHTSheaf(M_I)^0
            -> âŠ•_{I âŠ‚ ğ•€, |I|=2} PHTSheaf(M_I)^0 
            -> ...  
        ]
    }
  }

  NOTATION {
    "F =[Îµ]= G" = InterleavingDist(F, G) â‰¤ Îµ
    "M â‰ƒ[Îµ] N" = Îµ-Homotopic(M, N, Îµ)
    "Ï_F" = CanonicalMap(F, ShiftFunctor[Îµ](F))
    "Ï_G" = CanonicalMap(G, ShiftFunctor[Îµ](G))
    "ğ•€" = {1..k} WHERE k = |Triangulation(M)|
    "M_I" = â‹‚_{i âˆˆ I} Triangulation(M)[i] 
  }

  TRANSFORMERS {
    FUNC LimDiagram[U : FiniteCover, F : D^b(Shv(-))] = {
      LET I = PowerSet(U)
      [F(â‹ƒI_k) -> F(â‹ƒI_(k-1)) | k <- [1..|I|]]
    }

    FUNC HolimCone[U : FiniteCover, F : D^b(Shv(-))] = Cone(LimDiagram[U, F])
    
    TACTIC SimplifyInterleaving[F G : D^b(Shv(Direction * Filtration)), Îµ : R^â‰¥0] = {
      REWRITE Îµ-Interleaving(F, G, Îµ)
        <=> âˆƒ (Ï† : ShiftFunctor[Îµ](F) -> G) (Ïˆ : ShiftFunctor[Îµ](G) -> F) .
              Ï† âˆ˜ ShiftFunctor[Îµ](Ïˆ) = ShiftFunctor[2Îµ](Ï_G) âˆ§ 
              Ïˆ âˆ˜ ShiftFunctor[Îµ](Ï†) = ShiftFunctor[2Îµ](Ï_F)
        <=> InterleavingDist(F, G) â‰¤ Îµ
    }
    
    TACTIC SimplifyHomotopy[M N : Shape, Îµ : R^â‰¥0] = {
      REWRITE Îµ-Homotopic(M, N, Îµ)
        <=> âˆƒ (Ï† : M -> N) (Ïˆ : N -> M) .
              (âˆ€ m : M . |m - Ï†(m)| â‰¤ Îµ) âˆ§
              (âˆ€ n : N . |n - Ïˆ(n)| â‰¤ Îµ) âˆ§
              (Ï† âˆ˜ Ïˆ â‰ƒ Id_N) âˆ§ (Ïˆ âˆ˜ Ï† â‰ƒ Id_M)
        <=> M â‰ƒ[Îµ] N
    }
  }

  STRUCTURE Interleaving {
    REQUIRE âˆ€ F G : D^b(Shv(Direction * Filtration)) . 
      InterleavingDist(F, G) = inf {Îµ | Îµ-Interleaving(F, G, Îµ)}
  }

  STRUCTURE PointSampling {
    DEF ConditionNumber(M : Submanifold) : R^>0 = 
      inf {r | âˆ€ (p : M) . reach(p,M) â‰¥ r}

    DEF SampleDense(M : Submanifold, Îµ Î´ : R^>0) : Shape =
      {X âŠ† M | X is (Îµ/2)-dense in M with prob â‰¥ 1-Î´}

    FUNC AlphaComplex(X : Shape, Îµ : R^>0) -> Polyhedron = {
      LET U = â‹ƒ_{x âˆˆ X} B_Îµ(x)
      LET V = VoronoiCells(X)
      Nerve(U âˆ© V)  
    }
  }

  PROOFS {
    TACTIC MayerVietoris(U : FiniteCover) = {
      APPLY Mayer-Vietoris(U)
      APPLY Seifert-van-Kampen(U)
    }

    TACTIC CechDerivedSS(U : FiniteCover, F : D^b(Shv(X))) = {
      LET E^1, E^2 = spectral sequence of F w.r.t. U
      
      REWRITE E^1_pq = âŠ•_{I âŠ† ğ•€, |I|=p+1} H^q(F(U_I)),
              E^2_pq = H^p[q â†¦ âŠ•_{I âŠ† ğ•€, |I|=p+1} F(U_I)^q]
        
      HAVE E^1 collapses => E^2 = E^âˆ
      HENCE H^n(F) â‰ƒ H^n[Câ€¢(U;F^0)]
    }

    THEOREM StabilityOfPHT {
      STATEMENT: 
        âˆ€ (M N : Shape) (Îµ : R^â‰¥0) . 
          (M â‰ƒ[Îµ] N) <=> (PHTSheaf(M) =[Îµ]= PHTSheaf(N))
      
      PROOF:
        LET M N : Shape, Îµ : R^â‰¥0
        
        SHOW (M â‰ƒ[Îµ] N) => (PHTSheaf(M) =[Îµ]= PHTSheaf(N)) BY {
          ASSUME (H1) : M â‰ƒ[Îµ] N
          BY SimplifyHomotopy[M, N, Îµ]
          LET Ï†, Ïˆ = witnesses of H1
          SHOW Ï†, Ïˆ define an Îµ-interleaving of PHTSheaf(M), PHTSheaf(N)
          BY SimplifyInterleaving[PHTSheaf(M), PHTSheaf(N), Îµ]  
        }
        
        SHOW (PHTSheaf(M) =[Îµ]= PHTSheaf(N)) => (M â‰ƒ[Îµ] N) BY {
          ASSUME (H2) : PHTSheaf(M) =[Îµ]= PHTSheaf(N)
          BY SimplifyInterleaving[PHTSheaf(M), PHTSheaf(N), Îµ]
          LET Ï†, Ïˆ = witnesses of Îµ-interleaving from H2
          HAVE Ï†, Ïˆ induce continuous maps M -> N, N -> M
          SHOW these maps define an Îµ-homotopy equiv.
          BY SimplifyHomotopy[M, N, Îµ]
        } 
          
        QED
    }

    THEOREM PHTGluingProof {
      STATEMENT:
        âˆ€ (M : Shape) (U : List[Shape]) . 
          FiniteCover(U, M) => ÄŒechDescent(PHTSheaf(M), U)
      
      PROOF:
        LET M : Shape, U : List[Shape] 
        ASSUME (H) : FiniteCover(U, M) 
        LET F = PHTSheaf(M)
        
        SUFFICES_TO_SHOW 
          F(â‹ƒU) -> holim[âˆF(U_i)|i]
                |         |
          F(â‹ƒU âˆ© Dir) -> holim[âˆF(U_i âˆ© Dir)|i] 
        is a homotopy pullback square  

        BY MayerVietoris(U)
          SHOW holim[âˆF(U_i)|i] â‰ƒ HolimCone[U, F] â‰ƒ F(â‹ƒU)
          SHOW holim[âˆF(U_i âˆ© Dir)|i] â‰ƒ HolimCone[U, F(-âˆ©Dir)] â‰ƒ F(â‹ƒU âˆ© Dir)
        
        QED  
    }

    THEOREM PHTPolyhedronNerveProof {
      STATEMENT: 
        âˆ€ (M : Shape) (n : â„•) . IsPolyhedron(M) =>
          PHTSheaf(M)^n â‰ƒ H^n[0 -> âŠ•PHTSheaf(M_I)^0 -> âŠ•PHTSheaf(M_I)^0 -> ...]
      
      PROOF:
        LET M : Shape, n : â„•
        ASSUME IsPolyhedron(M)
        LET T = Triangulation(M)
        
        HAVE (H) : FiniteCover(T, M)
        
        BY CechDerivedSS(T, PHTSheaf(M))
        HAVE âˆ€ (I : ğ•€^k, k>0) . H^n(PHTSheaf(M_I)) = 0 for n>0
          BECAUSE M_I is contractible
        
        HENCE spectral sequence collapses
        THUS PHTSheaf(M)^n â‰ƒ H^n[Câ€¢(T;PHTSheaf(-)^0)] 

        QED
    }
    
    THEOREM Approximation {
      STATEMENT:
        âˆ€ (M : Submanifold) (Îµ Î´ : R^>0) . Îµ < ConditionNumber(M)/2 =>
          InterleavingDist(PHTSheaf(M), PHTSheaf(AlphaComplex(SampleDense(M,Îµ,Î´), Îµ))) 
          â‰¤ Îµ/2 WITH PROBABILITY â‰¥ 1-Î´
    
      PROOF:
        LET M : Submanifold, Îµ Î´ : R^>0
        ASSUME Îµ < ConditionNumber(M)/2
        LET X = SampleDense(M, Îµ, Î´), U = â‹ƒ_{x âˆˆ X} B_Îµ(x), K = AlphaComplex(X, Îµ)
        
        HAVE (H1) : M â‰ƒ U BY Theorem 4.15
        HAVE (H2) : U â‰ƒ K BY Nerve Lemma
        
        DEFINE Ï† : M -> K = NearestPoint_K âˆ˜ H_M(1,-)
               Ïˆ : K -> M = H_M(1,-) âˆ˜ NearestPoint_U
          WHERE H_M(t,x) = (1-t)x + t(x - ÎµÂ·grad dist_M(x)),
                H_K(t,u) = u - t Â· line(u, NearestPoint_K(u))
        
        SHOW âˆ€ m : M . |m - Ï†(m)| â‰¤ Îµ,
             âˆ€ k : K . |k - Ïˆ(k)| â‰¤ Îµ
        SHOW Ïˆ âˆ˜ Ï† â‰ƒ Id_M,
             Ï† âˆ˜ Ïˆ â‰ƒ Id_K
        
        BY SimplifyHomotopy[M, K, Îµ]  
        HENCE M â‰ƒ[Îµ] K
        
        BY SimplifyInterleaving[PHTSheaf(M), PHTSheaf(K), Îµ/2]
        BY StabilityOfPHT
        THUS PHTSheaf(M) =[Îµ/2]= PHTSheaf(K)
          
        QED
    }
  }
}