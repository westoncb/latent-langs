CONCEPT ConformalPrediction {
  LANGUAGE {
    TYPE X                     -- Input space
    TYPE Y                     -- Output space
    TYPE ‚Ñù‚Çä <: Real            -- Non-negative reals
    FUNC d : Y √ó Y -> ‚Ñù‚Çä        -- Metric on output space
    FUNC Œº : List[X] √ó List[Y] -> (X -> Y)  -- Base predictor trained on given data

    FUNC NonConformityScore(x : X, y : Y, S : List[X], T : List[Y]) : ‚Ñù‚Çä =
      LET m = Œº(S, T) IN d(y, m(x))

    FUNC ConformalSet(x : X, S : List[X], T : List[Y], Œµ : ‚Ñù‚Çä) : ùí´(Y) =
      LET Œ±_i = NonConformityScore(S_i, T_i, DELETE(S, i), DELETE(T, i)) for i = 1..|S|
          Œ±_Œµ = Quantile(Œ±_1, ..., Œ±_|S|, 1 - Œµ)  
      IN {y : Y | NonConformityScore(x, y, S, T) ‚â§ Œ±_Œµ}

    NOTATION "ùí´" = PowerSet
    NOTATION "DELETE" = Œª(X : List[A]) (i : Nat), CONCAT(TAKE(X, i-1), DROP(X, i))
    NOTATION "Quantile" = Œª(X : List[Real]) (p : Real), SORT(X)_FLOOR(p * |X|)
  }

  STRUCTURE ConformalPredictor(S : List[X], T : List[Y], Œµ : ‚Ñù‚Çä) {
    REQUIRE Œµ ‚àà (0, 1)
    REQUIRE |S| = |T| > 0

    DEF Predict(x : X) : ùí´(Y) = ConformalSet(x, S, T, Œµ)

    THEOREM Validity {
      ‚àÄ(P : ùí´(X √ó Y)), P(Predict(X) ‚àã Y) ‚â• 1 - Œµ  
    }
    PROOF {
      LET P : ùí´(X √ó Y), (S', T') = (CONCAT(S, [X]), CONCAT(T, [Y])) 
      
      P(Predict(X) ‚àã Y)
        = P({y : Y | NonConformityScore(X, y, S', T') ‚â§ Quantile({NonConformityScore(S'_i, T'_i, DELETE(S', i), DELETE(T', i)) | i = 1..|S'|}, 1 - Œµ)} ‚àã Y)
        = P(NonConformityScore(X, Y, S', T') ‚â§ Quantile({NonConformityScore(S'_i, T'_i, DELETE(S', i), DELETE(T', i)) | i = 1..|S'|}, 1 - Œµ))
        ‚â• P(Rank(NonConformityScore(X, Y, S', T'), {NonConformityScore(S'_i, T'_i, DELETE(S', i), DELETE(T', i)) | i = 1..|S'|}) > Œµ * (|S'| + 1))
        = P(U > Œµ)  where U ~ Uniform(0, 1)
        = 1 - Œµ
    }

    THEOREM Efficiency {
      ‚àÄ(P : ùí´(X √ó Y)), E[P, Œª(x : X), SIZE(Predict(x))] ‚â§ (1 / (1 - Œµ)) * E[P, Œª((x, y) : X √ó Y), NonConformityScore(x, y, S, T)]
    }
    PROOF {
      LET P : ùí´(X √ó Y), f = Œª((x, y) : X √ó Y), NonConformityScore(x, y, S, T)
      
      E[P, Œª(x : X), SIZE(Predict(x))]  
        = E[P, Œª(x : X), P(Y | Predict(x) ‚àã Y) * SIZE(Y)]
        ‚â§ (1 / (1 - Œµ)) * E[P, Œª(x : X), P(Y | f(x, Y) ‚â§ Quantile(f(S, T), 1 - Œµ)) * SIZE(Y)]
        = (1 / (1 - Œµ)) * E[P, Œª(x : X), E[P(Y | X = x), Œª(y : Y), ùüô{f(x, y) ‚â§ Quantile(f(S, T), 1 - Œµ)} * 1]]  
        = (1 / (1 - Œµ)) * E[P, Œª((x, y) : X √ó Y), ùüô{f(x, y) ‚â§ Quantile(f(S, T), 1 - Œµ)}]
        ‚â§ (1 / (1 - Œµ)) * E[P, Œª((x, y) : X √ó Y), f(x, y) / Quantile(f(S, T), 1 - Œµ)]
        = (1 / (1 - Œµ)) * E[P, f]
    }
  }
}