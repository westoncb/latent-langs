CONCEPT ConformalGeometry {
  LANGUAGE {
    TYPE Manifold
    TYPE Metric[M : Manifold] = Tensor[Symmetric[2], M, ‚Ñù]
    TYPE WeylTensor[M : Manifold] = Tensor[Symmetric[2] ‚äó Antisymmetric[2], M, ‚Ñù]
    TYPE Connection[M : Manifold] = Christoffel[M]
    TYPE Density[w : ‚Ñ§, M : Manifold] = Œì(DensityBundle[w, M])

    FUNC Christoffel(g : Metric[M]) : Connection[M]
    FUNC Weyl(g : Metric[M]) : WeylTensor[M]
    FUNC Schouten(g : Metric[M]) : Tensor[Symmetric[2], M, ‚Ñù]
    FUNC Cotton(g : Metric[M]) : Tensor[Symmetric[3], M, ‚Ñù]
    FUNC Bach(g : Metric[M]) : Tensor[Symmetric[2], M, ‚Ñù]
    FUNC Yamabe(g : Metric[M]) : Density[2-dim(M)/2, M] -> Metric[M]

    AXIOM MetricRescaling {
      ‚àÄ(M : Manifold, g : Metric[M], f : C^‚àû(M)).
        Weyl(Exp(2*f) * g) = Weyl(g)
    }

    NOTATION "C" = Weyl
    NOTATION "P" = Schouten  
    NOTATION "B" = Bach
    NOTATION "Y[g, œÉ]" = Yamabe(g)(œÉ)
  }

  STRUCTURE conformalManifold(M : Manifold, ùíû : Metric[M] -> Prop) {
    REQUIRE ‚àÄ(g h : Metric[M]). ùíû(g) ‚àß (‚àÉ(f : C^‚àû(M)). h = Exp(2*f)*g) ‚áí ùíû(h)
  }

  STRUCTURE einsteinManifold(M : Manifold, g : Metric[M]) {
    REQUIRE Ric(g) = Œª * g   -- Ric is the Ricci tensor
      WHERE Œª : C^‚àû(M)

    REQUIRE WHEN dim(M) > 2 THEN Weyl(g) = 0
  }

  PROOFS {
    TACTIC ConformalRescaling {
      MATCH (g : Metric[M], h : Metric[M], ùíû : Metric[M] -> Prop) 
        WHERE ‚àÉ(f : C^‚àû(M)). h = Exp(2*f) * g
      ASSUME ùíû(g)
      SHOW ùíû(h)
    }

    THEOREM WeylInvariance {
      STATEMENT:
        ‚àÄ(M : Manifold, g h : Metric[M]).
          (‚àÉ(f : C^‚àû(M)). h = Exp(2*f) * g) ‚áí C(h) = C(g)

      PROOF:
        LET M : Manifold, g h : Metric[M], f : C^‚àû(M)
        ASSUME h = Exp(2*f) * g
        SHOW C(h) = C(g) BY MetricRescaling
    }

    THEOREM SchoutenTransformation {
      STATEMENT:  
        ‚àÄ(M : Manifold, g : Metric[M], f : C^‚àû(M)).
          P(Exp(2*f)*g) = P(g) - Hess(f) + df‚äódf - (1/2)|df|^2_g * g
            WHERE Hess(f) = Covariant[Christoffel(g)](Covariant[Christoffel(g)](f))

      PROOF:
        LET M : Manifold, g : Metric[M], f : C^‚àû(M)
        LET h = Exp(2*f) * g
        REWRITE P(h) 
          = (1/(dim(M)-2)) * (Ric(h) - (R(h)/(2*(dim(M)-1))) * h)   BY DEFINITION Schouten
          = (1/(dim(M)-2)) * (Ric(g) - 2(dim(M)-1)*Hess(f) + Œî(f)*g 
              - (R(g) - 2(dim(M)-1)*Œî(f) - (dim(M)-1)(dim(M)-2)|df|^2_g)/(2*(dim(M)-1)) * h)
              BY ConformalChangeOfRicciCurvature
          = P(g) - Hess(f) + df‚äódf - (1/2)|df|^2_g * g              BY ALGEBRA
    }

    THEOREM YamabeEquation {
      STATEMENT:
        ‚àÄ(M : Manifold, g : Metric[M], œÉ : Density[2-dim(M)/2, M]).
          R(Y[g, œÉ]) = œÉ^(4/(dim(M)-2)) * (R(g) * œÉ - 4((dim(M)-1)/(dim(M)-2)) * Œî_g(œÉ))
            WHERE Œî_g = Laplacian[g]

      PROOF:
        LET M : Manifold, g : Metric[M], œÉ : Density[2-dim(M)/2, M]
        DEF u = œÉ^(2/(dim(M)-2))  
        DEF h = Y[g, œÉ] = u^(4/(dim(M)-2)) * g
        REWRITE R(h)
          = u^(-4/(dim(M)-2)) * (R(g) - 4((dim(M)-1)/(dim(M)-2)) * (Œî_g(u)/u))  BY ConformalChangeOfScalarCurvature
          = œÉ^(-4/(dim(M)-2)) * (R(g) * œÉ - 4((dim(M)-1)/(dim(M)-2)) * Œî_g(œÉ))   BY ALGEBRA, SUBSTITUTION
    }
  }
}