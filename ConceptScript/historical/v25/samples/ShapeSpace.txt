CONCEPT ShapeSpace {
  LANGUAGE {
    TYPE Shape <: CS(R^d)
    TYPE Direction = S^(d-1)
    TYPE Filtration = R
    TYPE PersistenceDiagram = Dgm

    FUNC PHT[d : Nat](M : Shape) : Direction -> PersistenceDiagram^d
    FUNC PHTSheaf(M : Shape) : D^b(Shv(Direction * Filtration))
    FUNC InterleavingDist(F G : D^b(Shv(Direction * Filtration))) : R^‚â•0
    FUNC ShiftFunctor[Œµ : R^‚â•0](F : D^b(Shv(Direction * Filtration)))
      : D^b(Shv(Direction * Filtration))
    FUNC BottleneckDist(D E : PersistenceDiagram) : R^‚â•0
    FUNC WassersteinDist[p : R^‚â•1](D E : PersistenceDiagram) : R^‚â•0

    PRED FiniteCover(U : List[Shape], M : Shape) =
      (‚ãÉ_{N ‚àà U} N = M) ‚àß Finite(U)
    PRED ƒåechDescent(F : D^b(Shv(Direction * Filtration)), U : FiniteCover) =
      F(‚ãÉU) ‚âÉ holim[ ‚àè_{N ‚àà U} F(N) => ‚àè_{N,N' ‚àà U} F(N ‚à© N') -> ... ]

    PRED Œµ-Interleaving(F G : D^b(Shv(Direction * Filtration)), Œµ : R^‚â•0) =
      ‚àÉ (œÜ : ShiftFunctor[Œµ](F) -> G) (œà : ShiftFunctor[Œµ](G) -> F) .
        œÜ ‚àò ShiftFunctor[Œµ](œà) = ShiftFunctor[2Œµ](œÅ_G) ‚àß
        œà ‚àò ShiftFunctor[Œµ](œÜ) = ShiftFunctor[2Œµ](œÅ_F)

    PRED Œµ-Homotopic(M N : Shape, Œµ : R^‚â•0) =
      ‚àÉ (œÜ : M -> N) (œà : N -> M) .
        (‚àÄ m : M . |m - œÜ(m)| ‚â§ Œµ) ‚àß
        (‚àÄ n : N . |n - œà(n)| ‚â§ Œµ) ‚àß
        (œÜ ‚àò œà ‚âÉ Id_N) ‚àß (œà ‚àò œÜ ‚âÉ Id_M)

    AXIOM PHTGluing {
      ‚àÄ (M : Shape) (U : List[Shape]) .
        FiniteCover(U, M) => ƒåechDescent(PHTSheaf(M), U)
    }

    AXIOM PHTPolyhedronNerve {
      ‚àÄ (M : Shape) (n : ‚Ñï) . IsPolyhedron(M) =>
        PHTSheaf(M)^n ‚âÉ H^n[
          0 -> ‚äï_{I ‚äÇ ùïÄ, |I|=1} PHTSheaf(M_I)^0
            -> ‚äï_{I ‚äÇ ùïÄ, |I|=2} PHTSheaf(M_I)^0
            -> ...
        ]
    }
  }

  NOTATION {  
    "F =[Œµ]= G" = InterleavingDist(F, G) ‚â§ Œµ
    "M ‚âÉ[Œµ] N" = Œµ-Homotopic(M, N, Œµ)
    "œÅ_F" = CanonicalMap(F, ShiftFunctor[Œµ](F))
    "œÅ_G" = CanonicalMap(G, ShiftFunctor[Œµ](G))
    "ùïÄ" = {1..k}
      WHERE k = |Triangulation(M)|
    "M_I" = ‚ãÇ_{i ‚àà I} Triangulation(M)[i]      
  }

  STRUCTURE Interleaving {
    REQUIRE ‚àÄ F G : D^b(Shv(Direction * Filtration)) .
      InterleavingDist(F, G) = inf {Œµ | Œµ-Interleaving(F, G, Œµ)}
  }

  STRUCTURE PointSampling {
    DEF ConditionNumber(M : Submanifold) : R^>0 =
      inf {r | ‚àÄ (p : M) . reach(p,M) ‚â• r}

    DEF SampleDense(M : Submanifold, Œµ Œ¥ : R^>0) : Shape =
      {X ‚äÜ M | X is (Œµ/2)-dense in M with prob ‚â• 1-Œ¥}

    FUNC AlphaComplex(X : Shape, Œµ : R^>0) -> Polyhedron =
      LET U = ‚ãÉ_{x ‚àà X} B_Œµ(x);  V = VoronoiCells(X)
      IN Nerve(U ‚à© V)
  }

  PROOFS {
    TACTIC MayerVietoris(U : FiniteCover) = 
      APPLY Mayer-Vietoris(U);
      APPLY Seifert-van-Kampen(U)

    TACTIC CechDerivedSS(U : FiniteCover, F : D^b(Shv(X))) = {
      LET E^1, E^2 = spectral sequence of F w.r.t. U

      REWRITE E^1_pq = ‚äï_{I ‚äÜ ùïÄ, |I|=p+1} H^q(F(U_I)),
              E^2_pq = H^p[q ‚Ü¶ ‚äï_{I ‚äÜ ùïÄ, |I|=p+1} F(U_I)^q]
        
      HAVE E^1 collapses => E^2 = E^‚àû  
      HENCE H^n(F) ‚âÉ H^n[C‚Ä¢(U;F^0)]
    }

    THEOREM StabilityOfPHT {
      STATEMENT:
        ‚àÄ (M N : Shape) (Œµ : R^‚â•0) .
          (M ‚âÉ[Œµ] N) <=> (PHTSheaf(M) =[Œµ]= PHTSheaf(N))
      
      PROOF:
        LET M N : Shape, Œµ : R^‚â•0

        SHOW (M ‚âÉ[Œµ] N) => (PHTSheaf(M) =[Œµ]= PHTSheaf(N)) BY {
          ASSUME (H1) : M ‚âÉ[Œµ] N
          LET œÜ, œà = witnesses of H1
          SHOW œÜ, œà define an Œµ-interleaving of PHTSheaf(M), PHTSheaf(N)  
        }

        SHOW (PHTSheaf(M) =[Œµ]= PHTSheaf(N)) => (M ‚âÉ[Œµ] N) BY {
          ASSUME (H2) : PHTSheaf(M) =[Œµ]= PHTSheaf(N)
          LET œÜ, œà = witnesses of Œµ-interleaving from H2
          HAVE œÜ, œà induce continuous maps M -> N, N -> M
          SHOW these maps define an Œµ-homotopy equiv.
        }

        QED
    }

    THEOREM PHTGluingProof {
      STATEMENT:
        ‚àÄ (M : Shape) (U : List[Shape]) .
          FiniteCover(U, M) => ƒåechDescent(PHTSheaf(M), U)
      
      PROOF:
        LET M : Shape, U : List[Shape] 
        ASSUME (H) : FiniteCover(U, M)
        LET F = PHTSheaf(M)

        SUFFICES TO SHOW
          F(‚ãÉU) -> holim[‚àèF(U_i)|i]
                |         |
          F(‚ãÉU ‚à© Dir) -> holim[‚àèF(U_i ‚à© Dir)|i]
        is a homotopy pullback square

        BY MayerVietoris(U)
        
        QED
    }
      
    THEOREM PHTPolyhedronNerveProof {  
      STATEMENT:
        ‚àÄ (M : Shape) (n : ‚Ñï) . IsPolyhedron(M) =>
          PHTSheaf(M)^n ‚âÉ H^n[0 -> ‚äïPHTSheaf(M_I)^0 -> ‚äïPHTSheaf(M_I)^0 -> ...]
      
      PROOF:  
        LET M : Shape, n : ‚Ñï
        ASSUME IsPolyhedron(M)
        LET T = Triangulation(M)

        HAVE (H) : FiniteCover(T, M)

        BY CechDerivedSS(T, PHTSheaf(M))  
        
        HAVE ‚àÄ (I : ùïÄ^k, k>0) . H^n(PHTSheaf(M_I)) = 0  for n>0
          BECAUSE M_I is contractible

        HENCE spectral sequence collapses
        
        THUS PHTSheaf(M)^n ‚âÉ H^n[C‚Ä¢(T;PHTSheaf(-)^0)]
        
        QED
    }

    THEOREM Approximation {
      STATEMENT:
        ‚àÄ (M : Submanifold) (Œµ Œ¥ : R^>0) . Œµ < ConditionNumber(M)/2 =>
          InterleavingDist(PHTSheaf(M), PHTSheaf(AlphaComplex(SampleDense(M,Œµ,Œ¥), Œµ)))
          ‚â§ Œµ/2 WITH PROBABILITY ‚â• 1-Œ¥
    
      PROOF:
        LET M : Submanifold, Œµ Œ¥ : R^>0  
        ASSUME Œµ < ConditionNumber(M)/2
        LET X = SampleDense(M, Œµ, Œ¥), U = ‚ãÉ_{x ‚àà X} B_Œµ(x), K = AlphaComplex(X, Œµ)

        HAVE (H1) : M ‚âÉ U  BY Theorem 4.15
        HAVE (H2) : U ‚âÉ K  BY Nerve Lemma

        DEFINE œÜ : M -> K = NearestPoint_K ‚àò H_M(1,-)
               œà : K -> M = H_M(1,-) ‚àò NearestPoint_U  
          WHERE H_M(t,x) = (1-t)x + t(x - Œµ¬∑grad dist_M(x)),
                H_K(t,u) = u - t ¬∑ line(u, NearestPoint_K(u))   

        SHOW ‚àÄ m : M . |m - œÜ(m)| ‚â§ Œµ,
             ‚àÄ k : K . |k - œà(k)| ‚â§ Œµ
        SHOW œà ‚àò œÜ ‚âÉ Id_M,
             œÜ ‚àò œà ‚âÉ Id_K

        HENCE M ‚âÉ[Œµ] K        
        THUS PHTSheaf(M) =[Œµ/2]= PHTSheaf(K)  BY StabilityOfPHT
        
        QED
    }  
  }
}






CONCEPT ShapeSpace {
  LANGUAGE {
    TYPE Shape <: CS(R^d)
    TYPE Direction = S^(d-1)
    TYPE Filtration = R
    TYPE PersistenceDiagram = Dgm

    FUNC PHT[d : Nat](M : Shape) : Direction -> PersistenceDiagram^d
    FUNC PHTSheaf(M : Shape) : D^b(Shv(Direction * Filtration))
    FUNC InterleavingDist(F G : D^b(Shv(Direction * Filtration))) : R^‚â•0
    FUNC ShiftFunctor[Œµ : R^‚â•0](F : D^b(Shv(Direction * Filtration)))
      : D^b(Shv(Direction * Filtration))
    FUNC BottleneckDist(D E : PersistenceDiagram) : R^‚â•0
    FUNC WassersteinDist[p : R^‚â•1](D E : PersistenceDiagram) : R^‚â•0

    PRED FiniteCover(U : List[Shape], M : Shape) : ùîπ =
      (‚ãÉ_{N ‚àà U} N = M) ‚àß Finite(U)
    PRED ƒåechDescent(F : D^b(Shv(Direction * Filtration)), U : FiniteCover) : ùîπ =
      F(‚ãÉU) ‚âÉ holim[ ‚àè_{N ‚àà U} F(N) => ‚àè_{N,N' ‚àà U} F(N ‚à© N') -> ... ]

    PRED Œµ-Interleaving(F G : D^b(Shv(Direction * Filtration)), Œµ : R^‚â•0) : ùîπ =
      ‚àÉ (œÜ : ShiftFunctor[Œµ](F) -> G) (œà : ShiftFunctor[Œµ](G) -> F) .
        œÜ ‚àò ShiftFunctor[Œµ](œà) = ShiftFunctor[2Œµ](œÅ_G) ‚àß
        œà ‚àò ShiftFunctor[Œµ](œÜ) = ShiftFunctor[2Œµ](œÅ_F)
      WHERE œÅ_F : F -> ShiftFunctor[Œµ](F),
            œÅ_G : G -> ShiftFunctor[Œµ](G)

    PRED Œµ-Homotopic(M N : Shape, Œµ : R^‚â•0) : ùîπ =
      ‚àÉ (œÜ : M -> N) (œà : N -> M) .
        (‚àÄ m : M . |m - œÜ(m)| ‚â§ Œµ) ‚àß
        (‚àÄ n : N . |n - œà(n)| ‚â§ Œµ) ‚àß
        (œÜ ‚àò œà ‚âÉ Id_N) ‚àß (œà ‚àò œÜ ‚âÉ Id_M)

    AXIOM PHTGluing :
      ‚àÄ (M : Shape) (U : List[Shape]) .
        FiniteCover(U, M) ‚áí ƒåechDescent(PHTSheaf(M), U)

    AXIOM PHTPolyhedronNerve :
      ‚àÄ (M : Shape) (n : ‚Ñï) . IsPolyhedron(M) ‚áí
        PHTSheaf(M)^n ‚âÉ H^n[
          0 -> ‚äï_{I ‚äÇ ùïÄ, |I|=1} PHTSheaf(M_I)^0
            -> ‚äï_{I ‚äÇ ùïÄ, |I|=2} PHTSheaf(M_I)^0
            -> ...
        ]
        WHERE ùïÄ = {1..k}, k = |Triangulation(M)|,
              M_I = ‚ãÇ_{i ‚àà I} Triangulation(M)[i]

    NOTATION "F =[Œµ]= G" = InterleavingDist(F, G) ‚â§ Œµ
    NOTATION "M ‚âÉ[Œµ] N" = Œµ-Homotopic(M, N, Œµ)
  }

  STRUCTURE Interleaving {
    REQUIRE ‚àÄ F G : D^b(Shv(Direction * Filtration)) .
      InterleavingDist(F, G) = inf {Œµ | Œµ-Interleaving(F, G, Œµ)}
  }

  STRUCTURE PointSampling {
    DEF ConditionNumber(M : Submanifold) : R^>0 =
      inf {r | ‚àÄ (p : M) . reach(p,M) ‚â• r}

    DEF SampleDense(M : Submanifold, Œµ Œ¥ : R^>0) : Shape =
      {X ‚äÜ M | X is (Œµ/2)-dense in M with prob ‚â• 1-Œ¥}

    FUNC AlphaComplex(X : Shape, Œµ : R^>0) -> Polyhedron =
      LET U = ‚ãÉ_{x ‚àà X} B_Œµ(x);  V = VoronoiCells(X)
      IN Nerve(U ‚à© V)
  }

  PROOFS {
    TACTIC MayerVietoris(U : FiniteCover) -> ùîπ =
      APPLY Mayer-Vietoris(U)
      THEN Seifert-van-Kampen(U)

    TACTIC CechDerivedSS(U : FiniteCover, F : D^b(Shv(X)) =
      LET E^1, E^2 = spectral sequence of F w.r.t. U
      REWRITE E^1_pq = ‚äï_{I ‚äÜ ùïÄ, |I|=p+1} H^q(F(U_I))
              E^2_pq = H^p[q ‚Ü¶ ‚äï_{I ‚äÜ ùïÄ, |I|=p+1} F(U_I)^q]
      ARGUE E^1 collapses ‚áí E^2 = E^‚àû
      CONCLUDE H^n(F) ‚âÉ H^n[C‚Ä¢(U;F^0)]

    THEOREM StabilityOfPHT {
      STATEMENT:
        ‚àÄ (M N : Shape) (Œµ : R^‚â•0) .
          (M ‚âÉ[Œµ] N) ‚áî (PHTSheaf(M) =[Œµ]= PHTSheaf(N))

      PROOF:
        (‚áí) GIVEN M ‚âÉ[Œµ] N
        CONSTRUCT œÜ, œà from homotopy equiv.
        SHOW they define an Œµ-interleaving

        (‚áê) GIVEN PHTSheaf(M) =[Œµ]= PHTSheaf(N)
        LET œÜ, œà witness the interleaving
        SHOW they induce maps M -> N, N -> M
        SHOW these maps are Œµ-homotopy equiv.
    }

    THEOREM PHTGluingProof {
      STATEMENT:
        ‚àÄ (M : Shape) (U : List[Shape]) .
          FiniteCover(U, M) ‚áí ƒåechDescent(PHTSheaf(M), U)

      PROOF:
        LET F = PHTSheaf(M)
        SUFFICES TO SHOW
          F(‚ãÉU) -> holim[‚àèF(U_i)|i]
                  |        |
          F(‚ãÉU ‚à© Direction) -> holim[‚àèF(U_i ‚à© Direction)|i]
        is homotopy cartesian.

        MayerVietoris(U)
    }

    THEOREM PHTPolyhedronNerveProof {
      STATEMENT:
        ‚àÄ (M : Shape) (n : ‚Ñï) . IsPolyhedron(M) ‚áí
          PHTSheaf(M)^n ‚âÉ H^n[0 -> ‚äïPHTSheaf(M_I)^0 -> ‚äïPHTSheaf(M_I)^0 -> ...]

      PROOF:
        LET T = Triangulation(M)
        HAVE FiniteCover(T,M)

        CechDerivedSS(T, PHTSheaf(M))

        ARGUE ‚àÄ (I : ùïÄ^k, k>0) . H^n(PHTSheaf(M_I)) = 0 for n>0
          BY contractibility of M_I
        
        HENCE spectral sequence collapses  
        THUS PHTSheaf(M)^n ‚âÉ H^n[C‚Ä¢(T;PHTSheaf(-)^0)]
    }
    
    THEOREM Approximation {
      STATEMENT: 
        ‚àÄ (M : Submanifold) (Œµ Œ¥ : R^>0) . Œµ < ConditionNumber(M)/2 ‚áí
          InterleavingDist(PHTSheaf(M), PHTSheaf(AlphaComplex(SampleDense(M,Œµ,Œ¥), Œµ))) 
          ‚â§ Œµ/2 WITH PROBABILITY ‚â• 1-Œ¥
      
      PROOF:
        LET œÑ = ConditionNumber(M), X = SampleDense(M, Œµ, Œ¥), U = ‚ãÉ_{x ‚àà X} B_Œµ(x)

        HAVE M ‚âÉ U BY Theorem 4.15
        HAVE U ‚âÉ AlphaComplex(X,Œµ) =: K BY Nerve Lemma

        DEFINE œÜ : M -> K = NearestPoint_K ‚àò H_M(1,-)
               œà : K -> M = H_M(1,-) ‚àò NearestPoint_U  
          WHERE H_M(t,x) = (1-t)x + t(x - Œµ¬∑grad dist_M(x))
                H_K(t,u) = u - t ¬∑ line(u, NearestPoint_K(u))

        SHOW ‚àÄ m : M . |m - œÜ(m)| ‚â§ Œµ
             ‚àÄ k : K . |k - œà(k)| ‚â§ Œµ  
        SHOW œà ‚àò œÜ ‚âÉ Id_M ‚àß œÜ ‚àò œà ‚âÉ Id_K

        THUS M ‚âÉ[Œµ] K
        HENCE PHTSheaf(M) =[Œµ/2]= PHTSheaf(K) BY StabilityOfPHT
    }
  }      
}






CONCEPT ShapeSpace {
  LANGUAGE {
    TYPE Shape <: CS(R^d)
    TYPE Direction = S^(d-1)  
    TYPE Filtration = R
    TYPE PersistenceDiagram = Dgm
    
    FUNC PHT[d : Nat](M : Shape) : Direction -> PersistenceDiagram^d
    FUNC PHTSheaf(M : Shape) : D^b(Shv(Direction * Filtration))
    FUNC InterleavingDist(F G : D^b(Shv(Direction * Filtration))) : R^‚â•0
    FUNC ShiftFunctor[Œµ : R^‚â•0](F : D^b(Shv(Direction * Filtration))) 
      : D^b(Shv(Direction * Filtration))
    FUNC BottleneckDist(D E : PersistenceDiagram) : R^‚â•0  
    FUNC WassersteinDist[p : R^‚â•1](D E : PersistenceDiagram) : R^‚â•0
    
    PRED FiniteCover(U : List[Shape], M : Shape) : ùîπ = 
      (‚ãÉ_{N ‚àà U} N = M) ‚àß Finite(U)
    PRED ƒåechDescent(F : D^b(Shv(Direction * Filtration)), U : FiniteCover) : ùîπ =
      F(‚ãÉU) ‚âÉ holim[ ‚àè_{N ‚àà U} F(N) => ‚àè_{N,N' ‚àà U} F(N ‚à© N') -> ... ]
      
    AXIOM PHTGluing : 
      ‚àÄ (M : Shape) (U : List[Shape]) . 
        FiniteCover(U, M) ‚áí ƒåechDescent(PHTSheaf(M), U)
        
    AXIOM PHTPolyhedronNerve :
      ‚àÄ (M : Shape) (n : ‚Ñï) . IsPolyhedron(M) ‚áí  
        PHTSheaf(M)^n ‚âÉ H^n[ 
          0 -> ‚äï_{I ‚äÇ ùïÄ, |I|=1} PHTSheaf(M_I)^0
            -> ‚äï_{I ‚äÇ ùïÄ, |I|=2} PHTSheaf(M_I)^0
            -> ...  
        ]
        WHERE ùïÄ = {1..k}, k = |Triangulation(M)|, 
              M_I = ‚ãÇ_{i ‚àà I} Triangulation(M)[i]
      
    NOTATION "F =[Œµ]= G" = InterleavingDist(F, G) ‚â§ Œµ     
    NOTATION "M ‚âÉ[Œµ] N" = 
      ‚àÉ (œÜ : M -> N) (œà : N -> M) .
        (‚àÄ m : M . |m - œÜ(m)| ‚â§ Œµ) ‚àß 
        (‚àÄ n : N . |n - œà(n)| ‚â§ Œµ) ‚àß
        (œÜ ‚àò œà ‚âÉ Id_N) ‚àß (œà ‚àò œÜ ‚âÉ Id_M)
  }

  STRUCTURE Interleaving {  
    DEF Œµ-Interleaving(F G : D^b(Shv(Direction * Filtration)), Œµ : R^‚â•0) = 
      ‚àÉ (œÜ : ShiftFunctor[Œµ](F) -> G) (œà : ShiftFunctor[Œµ](G) -> F) . 
        œÜ ‚àò ShiftFunctor[Œµ](œà) = ShiftFunctor[2Œµ](œÅ_G) ‚àß
        œà ‚àò ShiftFunctor[Œµ](œÜ) = ShiftFunctor[2Œµ](œÅ_F)
      WHERE œÅ_F : F -> ShiftFunctor[Œµ](F), 
            œÅ_G : G -> ShiftFunctor[Œµ](G)
        
    REQUIRE ‚àÄ F G : D^b(Shv(Direction * Filtration)) .
      InterleavingDist(F, G) = inf {Œµ | Œµ-Interleaving(F, G, Œµ)}        
  }
  
  STRUCTURE Stability {
    THEOREM StabilityOfPHT {
      STATEMENT: 
        ‚àÄ (M N : Shape) (Œµ : R^‚â•0) . 
          (M ‚âÉ[Œµ] N) ‚áî (PHTSheaf(M) =[Œµ]= PHTSheaf(N))

      PROOF:
        (‚áê) GIVEN M ‚âÉ[Œµ] N  
        CONSTRUCT œÜ, œà from homotopy equiv.
        SHOW they define an Œµ-interleaving
        
        (‚áí) GIVEN PHTSheaf(M) =[Œµ]= PHTSheaf(N)  
        LET œÜ, œà witness the interleaving
        SHOW they induce maps M -> N, N -> M 
        SHOW these maps are Œµ-homotopy equiv.
    }
  }

  STRUCTURE PointSampling {
    DEF ConditionNumber(M : Submanifold) : R^>0 =
      inf {r | ‚àÄ (p : M) . reach(p,M) ‚â• r}
        
    DEF SampleDense(M : Submanifold, Œµ Œ¥ : R^>0) : Shape =
      {X ‚äÜ M | X is (Œµ/2)-dense in M with prob ‚â• 1-Œ¥}  
        
    FUNC AlphaComplex(X : Shape, Œµ : R^>0) -> Polyhedron =
      LET U = ‚ãÉ_{x ‚àà X} B_Œµ(x);  V = VoronoiCells(X) 
      IN Nerve(U ‚à© V)
          
    THEOREM Approximation { 
      STATEMENT:
        ‚àÄ (M : Submanifold) (Œµ Œ¥ : R^>0) . Œµ < ConditionNumber(M)/2  ‚áí 
          InterleavingDist(PHTSheaf(M), PHTSheaf(AlphaComplex(SampleDense(M,Œµ,Œ¥), Œµ)))
          ‚â§ Œµ/2 WITH PROBABILITY ‚â• 1-Œ¥
            
      PROOF:  
        LET œÑ = ConditionNumber(M), X = SampleDense(M, Œµ, Œ¥), U = ‚ãÉ_{x ‚àà X} B_Œµ(x)
        
        HAVE M ‚âÉ U BY Theorem 4.15  
        HAVE U ‚âÉ AlphaComplex(X,Œµ) =: K BY Nerve Lemma
        
        DEFINE œÜ : M -> K = NearestPoint_K ‚àò H_M(1,-) 
               œà : K -> M = H_M(1,-) ‚àò NearestPoint_U
          WHERE H_M(t,x) = (1-t)x + t(x - Œµ¬∑grad dist_M(x))
                H_K(t,u) = u - t ¬∑ line(u, NearestPoint_K(u))  
                  
        SHOW ‚àÄ m : M . |m - œÜ(m)| ‚â§ Œµ   
             ‚àÄ k : K . |k - œà(k)| ‚â§ Œµ
        SHOW œà ‚àò œÜ ‚âÉ Id_M ‚àß œÜ ‚àò œà ‚âÉ Id_K
        
        THUS M ‚âÉ[Œµ] K
        HENCE PHTSheaf(M) =[Œµ/2]= PHTSheaf(K) BY StabilityOfPHT
    }
  }

  PROOFS {      
    TACTIC MayerVietoris(U : FiniteCover) -> ùîπ = 
      APPLY Mayer-Vietoris(U) 
      THEN Seifert-van-Kampen(U)
        
    TACTIC CechDerivedSS(U : FiniteCover, F : D^b(Shv(X)) = 
      LET E^1, E^2 = spectral sequence of F w.r.t. U
      REWRITE E^1_pq = ‚äï_{I ‚äÜ ùïÄ, |I|=p+1} H^q(F(U_I))  
              E^2_pq = H^p[q ‚Ü¶ ‚äï_{I ‚äÜ ùïÄ, |I|=p+1} F(U_I)^q]
      ARGUE E^1 collapses ‚áí E^2 = E^‚àû  
      CONCLUDE H^n(F) ‚âÉ H^n[C‚Ä¢(U;F^0)]

    THEOREM PHTGluingProof {
      STATEMENT: 
        ‚àÄ (M : Shape) (U : List[Shape]) .
          FiniteCover(U, M) ‚áí ƒåechDescent(PHTSheaf(M), U)

      PROOF:  
        LET F = PHTSheaf(M)  
        SUFFICES TO SHOW  
          F(‚ãÉU) -> holim[‚àèF(U_i)|i] 
                  |        |  
          F(‚ãÉU ‚à© Direction) -> holim[‚àèF(U_i ‚à© Direction)|i]
        is homotopy cartesian.  
          
        MayerVietoris(U)
    }
      
    THEOREM PHTPolyhedronNerveProof {
      STATEMENT:
        ‚àÄ (M : Shape) (n : ‚Ñï) . IsPolyhedron(M) ‚áí
          PHTSheaf(M)^n ‚âÉ H^n[0 -> ‚äïPHTSheaf(M_I)^0 -> ‚äïPHTSheaf(M_I)^0 -> ...]
      
      PROOF:  
        LET T = Triangulation(M)
        HAVE FiniteCover(T,M)  

        CechDerivedSS(T, PHTSheaf(M))

        ARGUE ‚àÄ (I : ùïÄ^k, k>0) . H^n(PHTSheaf(M_I)) = 0 for n>0
          BY contractibility of M_I
        
        HENCE spectral sequence collapses
        THUS PHTSheaf(M)^n ‚âÉ H^n[C‚Ä¢(T;PHTSheaf(-)^0)]
    }
  }      
}







CONCEPT ShapeSpace {
  LANGUAGE {
    TYPE Shape <: CS(R^d)
    TYPE Direction = S^(d-1) 
    TYPE Filtration = R
    TYPE PersistenceDiagram <: Dgm
    
    FUNC PHT[M : Shape] : Direction -> PersistenceDiagram^d
    FUNC PHTSheaf[M : Shape] : D^b(Shv(Direction * Filtration))  
    FUNC InterleavingDist : (D^b(Shv(Direction * Filtration)), D^b(Shv(Direction * Filtration))) -> R^‚â•0
    FUNC ShiftFunctor[Œµ : R^‚â•0] : D^b(Shv(Direction * Filtration)) -> D^b(Shv(Direction * Filtration))
    FUNC BottleneckDist : (PersistenceDiagram, PersistenceDiagram) -> R^‚â•0
    FUNC WassersteinDist[p : R^‚â•1] : (PersistenceDiagram, PersistenceDiagram) -> R^‚â•0

    PRED FiniteCover[U : List[Shape], M : Shape] : ùîπ = (‚ãÉ_{N ‚àà U} N = M) ‚àß Finite(U)
    PRED ƒåechDescent[F : D^b(Shv(Direction * Filtration)), U : List[Shape]] : ùîπ = 
      F(‚ãÉU) ‚âÉ holim[ Œ†_{N ‚àà U} F(N) => Œ†_{N,N' ‚àà U} F(N ‚à© N') -> ... ]
      
    AXIOM PHTInjective : ‚àÄ (M N : Shape) . PHT[M] = PHT[N] => M = N
    AXIOM PHTGluing : ‚àÄ (M : Shape) (U : List[Shape]) . FiniteCover[U, M] => ƒåechDescent[PHTSheaf[M], U]  
    AXIOM PHTPolyhedronNerve : ‚àÄ (M : Shape | IsPolyhedron(M)) (n : ‚Ñï) .
      PHTSheaf[M]^n ‚âÉ H‚Åø[ 0 -> ‚äï_{I ‚äÇ {1..k} | |I|=1} PHTSheaf[M_I]‚Å∞ 
                            -> ‚äï_{I ‚äÇ {1..k} | |I|=2} PHTSheaf[M_I]‚Å∞
                            -> ... ]
      WHERE k = |Triangulation(M)|
            M_I = ‚ãÇ_{i ‚àà I} Triangulation(M)[i]
            
    NOTATION "F =[Œµ]= G" = InterleavingDist(F, G) ‚â§ Œµ     
    NOTATION "M ‚âÉ[Œµ] N" = ‚àÉ (œÜ : M -> N) (œà : N -> M) .
      (‚àÄ (m : M) . |m - œÜ(m)| ‚â§ Œµ) ‚àß 
      (‚àÄ (n : N) . |n - œà(n)| ‚â§ Œµ) ‚àß
      (œÜ ‚àò œà ‚âÉ Id_N) ‚àß (œà ‚àò œÜ ‚âÉ Id_M)            
  }
   
  STRUCTURE Interleaving {
    DEF Œµ-Interleaving[F G : D^b(Shv(Direction * Filtration)), Œµ : R^‚â•0] = 
      ‚àÉ (œÜ : ShiftFunctor[Œµ](F) -> G) (œà : ShiftFunctor[Œµ](G) -> F) . 
        (œÜ ‚àò ShiftFunctor[Œµ](œà) = ShiftFunctor[2Œµ](œÅ_G)) ‚àß 
        (œà ‚àò ShiftFunctor[Œµ](œÜ) = ShiftFunctor[2Œµ](œÅ_F))
      WHERE œÅ_F : F -> ShiftFunctor[Œµ](F)  
            œÅ_G : G -> ShiftFunctor[Œµ](G)
            
    REQUIRE InterleavingDist(F, G) = inf { Œµ | Œµ-Interleaving[F, G, Œµ] }      
  }
   
  STRUCTURE StabilityTheorem {
    THEOREM Stability {
      STATEMENT: ‚àÄ (M N : Shape) (Œµ : R^‚â•0) . (M ‚âÉ[Œµ] N) <=> (PHTSheaf[M] =[Œµ]= PHTSheaf[N])
      PROOF:
        LET M N : Shape, Œµ : R^‚â•0
        (==>) 
          ASSUME M ‚âÉ[Œµ] N
          OBTAIN œÜ : M -> N, œà : N -> M SATISFYING Œµ-homotopy equivalence
          CONSTRUCT interleaving maps via Fig 4.3 
          HENCE PHTSheaf[M] =[Œµ]= PHTSheaf[N] 
        (<==)  
          ASSUME PHTSheaf[M] =[Œµ]= PHTSheaf[N]
          LET v : Direction
          HAVE PHTSheaf[M](v) =[Œµ]= PHTSheaf[N](v) in D^b(Shv(Filtration))
          HAVE ‚àÄ (i : ‚Ñï) . BottleneckDist(PHT[M](v)_i, PHT[N](v)_i) ‚â§ Œµ BY IsometryTheorem
          SHOW M ‚âÉ[Œµ] N
        QED  
    }
    
    THEOREM InterleavingBottleneckBound {
      STATEMENT:
        ‚àÄ (M N : Shape) (i : ‚Ñï) .
          InterleavingDist(PHTSheaf[M], PHTSheaf[N]) ‚â• sup_{v : Direction} BottleneckDist(PHT[M](v)_i, PHT[N](v)_i)
      PROOF:  
        LET Œµ = InterleavingDist(PHTSheaf[M], PHTSheaf[N])
        LET v : Direction
        HAVE PHTSheaf[M](v) =[Œµ]= PHTSheaf[N](v) in D^b(Shv(Filtration))  
        THEN BottleneckDist(PHT[M](v)_i, PHT[N](v)_i) ‚â§ Œµ BY IsometryTheorem
        HENCE sup_{v : Direction} BottleneckDist(...) ‚â§ Œµ
    }
  }

  STRUCTURE PointSampling { 
    LET ConditionNumber[M : Submanifold] : R^>0 = inf { r | ‚àÄ (p : M) . reach(p, M) ‚â• r }

    DEF SampleDense[M : Submanifold, Œµ Œ¥ : R^>0] : Shape = {
      X ‚äÜ M | (X is (Œµ/2)-dense in M) ‚àß (‚Ñô[X ‚äÜ M] ‚â• 1 - Œ¥) 
    }

    FUNC AlphaComplex : (Shape, R^>0) -> Polyhedron
    REWRITE AlphaComplex(X, Œµ) = Nerve(‚ãÉ_{x ‚àà X} B_Œµ(x) ‚ãÇ VoronoiCells(X))

    THEOREM Approximation {  
      STATEMENT:
        ‚àÄ (M : Submanifold) (Œµ Œ¥ : R^>0) . 
          Œµ < ConditionNumber[M] / 2 =>
          InterleavingDist(PHTSheaf[M], PHTSheaf[AlphaComplex(SampleDense[M, Œµ, Œ¥], Œµ)]) ‚â§ Œµ/2
        WITH PROBABILITY ‚â• 1 - Œ¥
        
      PROOF:  
        LET œÑ = ConditionNumber[M], X = SampleDense[M, Œµ, Œ¥]
        HAVE M ‚âÉ ‚ãÉ_{x ‚àà X} B_Œµ(x) =: U BY Theorem 4.15
        HAVE U ‚âÉ AlphaComplex(X, Œµ) =: K BY NerveLemma
        
        CONSTRUCT œÜ : M -> K, œà : K -> M WHERE
          œÜ = NearestPoint_K ‚àò H_M(1, -)  
          œà = H_M(1, -) ‚àò NearestPoint_U
          H_M(t, x) = (1-t)x + t ¬∑ (x - Œµ¬∑Grad(dist_M)(x))
          H_K(t, u) = u - t ¬∑ line(u, NearestPoint_K(u))
        
        SHOW ‚àÄ (m : M) . |m - œÜ(m)| ‚â§ Œµ USING |H_M(1, x) - x| ‚â§ Œµ 
        SHOW ‚àÄ (k : K) . |k - œà(k)| ‚â§ Œµ USING K ‚äÇ U, |H_U(1, u) - u| ‚â§ Œµ
        SHOW œà ‚àò œÜ ‚âÉ Id_M BY s ‚Ü¶ H_M(s, œÜ(-))  
        SHOW œÜ ‚àò œà ‚âÉ Id_K BY s ‚Ü¶ H_K(s, œà(-))
        
        HENCE M ‚âÉ[Œµ] K  
        THUS InterleavingDist(PHTSheaf[M], PHTSheaf[K]) ‚â§ Œµ/2 BY Stability 
    }
  }
   
  PROOFS {
    TACTIC ƒåechDescends[F : D^b(Shv(Direction * Filtration)), U : FiniteCover] -> ùîπ {
      SUFFICES TO SHOW homotopy cartesian square:
      
        F(‚ãÉU)           -> holim[ ‚äï F(N) | N ‚àà U ]
             restriction |             | restriction  
        F(‚ãÉU ‚ãÇ Dirxn) -> holim[ ‚äï F(N ‚ãÇ Dirxn) | N ‚àà U ]            
      
      APPLY Mayer-Vietoris 
      APPLY Seifert-van Kampen
      CONCLUDE homotopy cartesian
    }  
      
    TACTIC SpectralSequenceCollapse[M : Polyhedron] {  
      LET T : List[Shape] = Triangulation(M)
      LET (E¬π_pq, E¬≤_pq) be pages of spectral sequence PHTSheaf[M] w.r.t. T
      
      HAVE E¬π_pq = ‚äï_{I ‚äÇ {0..k} | |I|=p+1} Hq(PHTSheaf[M_I])  
      HAVE E¬≤_pq = Hp[q ‚Ü¶ ‚äï_{I ‚äÇ {0..k} | |I|=p+1} PHTSheaf[M_I]^q]
        BY ƒåechDescent[PHTSheaf[M], T] 
        
      SHOW ‚àÄ (p q > 0) (I : {0..k}^(p+1)) . Hq(PHTSheaf[M_I]) = 0
        BY contractibility of M_I
        
      DEDUCE E¬≤_pq = E^‚àû_pq for p,q > 0  
      CONCLUDE spectral sequence collapses  
    }
         
    THEOREM PHTGluingTheorem {
      STATEMENT:
        ‚àÄ (M : Shape) (U : List[Shape]) . FiniteCover[U, M] => ƒåechDescent[PHTSheaf[M], U]
      PROOF:
        LET M : Shape, U : List[Shape]  
        ASSUME FiniteCover[U, M]
        SHOW ƒåechDescent[PHTSheaf[M], U] BY ƒåechDescends[PHTSheaf[M], U]
    }
      
    THEOREM PolyhedronNerveTheorem {  
      STATEMENT:  
        ‚àÄ (M : Polyhedron) (n : ‚Ñï) .
          PHTSheaf[M]^n ‚âÉ Hn[ 0 -> ‚äï_{I ‚äÇ {1..k} | |I|=1} PHTSheaf[M_I]‚Å∞ 
                               -> ‚äï_{I ‚äÇ {1..k} | |I|=2} PHTSheaf[M_I]‚Å∞
                               -> ... ]  
            WHERE k = |Triangulation(M)|
                  M_I = ‚ãÇ_{i ‚àà I} Triangulation(M)[i]
      PROOF:
        LET M : Polyhedron, n : ‚Ñï  
        LET T = Triangulation(M)
        HAVE FiniteCover[T, M] BY def. of triangulation  
        
        APPLY SpectralSequenceCollapse[M]
        CONCLUDE PHTSheaf[M]^n ‚âÉ Hn[nerve complex]      
    }
  }
}





CONCEPT ShapeSpace {
  LANGUAGE {
    TYPE Shape <: CS(R^d)
    TYPE Direction <: S^(d-1)
    TYPE Filtration <: R 
    TYPE PersistenceDiagram <: Dgm  
    
    FUNC PHT(M : Shape) : Direction -> PersistenceDiagram^d
    FUNC PHTSheaf(M : Shape) : D^b(Shv(Direction x Filtration))
    FUNC InterleavingDist(F G : D^b(Shv(Direction x Filtration))) : R^‚â•0
    FUNC ShiftFunctor(Œµ : R^‚â•0) : 
      D^b(Shv(Direction x Filtration)) -> D^b(Shv(Direction x Filtration))
    FUNC BottleneckDist(D E : PersistenceDiagram) : R^‚â•0
    FUNC WassersteinDist(p : R^‚â•1)(D E : PersistenceDiagram) : R^‚â•0

    PRED FiniteCover(U : List[Shape])(M : Shape) <=>
      (‚ãÉ_{N ‚àà U} N = M) AND Finite(U) 
    PRED ƒåechDescent(F : D^b(Shv(Direction x Filtration)))(U : FiniteCover) <=>
      F(‚ãÉU) ‚âÉ holim[ Œ†_{N ‚àà U} F(N) => Œ†_{N,N' ‚àà U} F(N ‚à© N') -> ... ] 
      
    AXIOM PHTInjective {
      FORALL (M N : Shape) . PHT(M) = PHT(N) => M = N
    }  
    
    AXIOM PHTGluing {
      FORALL (M : Shape) (U : List[Shape]) . FiniteCover(U)(M) =>
        ƒåechDescent(PHTSheaf(M))(U)
    }

    AXIOM PHTPolyhedronNerve {
      FORALL (M : Shape) . IsPolyhedron(M) => FORALL (n : N) .
        PHTSheaf(M)^n ‚âÉ H‚Åø[ 
          0 -> ‚äï_{I ‚äÇ {1..k}, |I|=1} PHTSheaf(M_I)‚Å∞ 
            -> ‚äï_{I ‚äÇ {1..k}, |I|=2} PHTSheaf(M_I)‚Å∞
            -> ...
        ]   
        WHERE k = |Triangulation(M)|
        AND M_I = ‚ãÇ_{i ‚àà I} Triangulation(M)[i]
    }  
    
    NOTATION "F =[Œµ]= G" := InterleavingDist(F, G) ‚â§ Œµ   
    NOTATION "M ‚âÉ[Œµ] N" := EXISTS (œÜ : M -> N) (œà : N -> M) .
        (FORALL m : M . |m - œÜ(m)| ‚â§ Œµ) AND
        (FORALL n : N . |n - œà(n)| ‚â§ Œµ) AND
        (œÜ ‚àò œà ‚âÉ Id_N) AND (œà ‚àò œÜ ‚âÉ Id_M)
  }

  STRUCTURE Interleaving {
    DEF Œµ-Interleaving(F G : D^b(Shv(Direction x Filtration)))(Œµ : R^‚â•0) <=>
      EXISTS (œÜ : ShiftFunctor(Œµ)(F) -> G) (œà : ShiftFunctor(Œµ)(G) -> F) . 
        œÜ ‚àò ShiftFunctor(Œµ)(œà) = ShiftFunctor(2Œµ)(œÅ_G) AND
        œà ‚àò ShiftFunctor(Œµ)(œÜ) = ShiftFunctor(2Œµ)(œÅ_F)
      WHERE œÅ_F : F -> ShiftFunctor(Œµ)(F) and œÅ_G : G -> ShiftFunctor(Œµ)(G)
         are the natural shift transformations.
        
    REQUIRE InterleavingDist(F, G) = inf { Œµ | Œµ-Interleaving(F, G)(Œµ) }
  }

  STRUCTURE StabilityTheorem {
    THEOREM Stability {  
      FORALL (M N : Shape) (Œµ : R^‚â•0) . M ‚âÉ[Œµ] N  <=>  
        PHTSheaf(M) =[Œµ]= PHTSheaf(N)
    }
    PROOF {
      (<==) Follow Fig 4.3 to construct interleaving
      (==>) Evaluate interleaving on stalks & apply Isometry Thm  
    }
  
    LEMMA InterleavingBottleneckBound {
      FORALL (M N : Shape) (i : N) .
        InterleavingDist(PHTSheaf(M), PHTSheaf(N)) ‚â• 
        sup_{v : Direction} BottleneckDist(PHT(M)(v)_i, PHT(N)(v)_i)   
    }
    PROOF {
      Let Œµ = InterleavingDist(PHTSheaf(M), PHTSheaf(N)).
      FORALL (v : Direction) . 
        PHTSheaf(M)(v) =[Œµ]= PHTSheaf(N)(v) in D^b(Shv(Filtration))
        => BottleneckDist(PHT(M)(v)_i, PHT(N)(v)_i) ‚â§ Œµ by Isometry Thm
      HENCE sup_{v : Direction} BottleneckDist(...) ‚â§ Œµ.
    }  
  }
  
  STRUCTURE PointSampling {
    DEF ConditionNumber(M : Submanifold) : R^>0 = 
      inf { r | FORALL (p : M) . reach(p, M) ‚â• r }

    DEF SampleDense(M : Submanifold)(Œµ Œ¥ : R^>0) : Shape = {
      X ‚äÇ M SUCH THAT X is (Œµ/2)-dense in M with prob. ‚â• 1-Œ¥   
    }  
    
    FUNC AlphaComplex(X : Shape)(Œµ : R^>0) -> Polyhedron = {
      LET U = ‚ãÉ_{x ‚àà X} B_Œµ(x)
      LET V = VoronoiCells(X)
      RETURN Nerve(U ‚ãÇ V) 
    }
      
    THEOREM Approximation {
      FORALL (M : Submanifold) (Œµ : R^>0) (Œ¥ : R^>0) .
        Œµ < ConditionNumber(M) / 2  =>
        InterleavingDist(PHTSheaf(M), 
                         PHTSheaf(AlphaComplex(SampleDense(M, Œµ, Œ¥), Œµ))) 
        ‚â§ Œµ/2  
      WITH PROBABILITY ‚â• 1 - Œ¥
    }  
    PROOF {
      LET œÑ = ConditionNumber(M), X = SampleDense(M, Œµ, Œ¥).
      BY Theorem 4.15, HAVE M ‚âÉ ‚ãÉ_{x ‚àà X} B_Œµ(x) =: U   
      BY Nerve Lemma, HAVE U ‚âÉ AlphaComplex(X, Œµ) =: K  
      
      LET H_M(t, x) = (1-t)x + t ¬∑ (x - Œµ¬∑Grad(dist_M)(x)) // homotopy M -> U
          H_K(t, u) = u - t ¬∑ line(u, NearestPoint_K(u))  // homotopy U -> K
          œÜ = NearestPoint_K ‚àò H_M(1, -) : M -> K
          œà = H_M(1, -) ‚àò NearestPoint_U : K -> M   
      
      FORALL (m : M) . |m - œÜ(m)| ‚â§ Œµ   // since H_M moves pts by ‚â§ Œµ  
      FORALL (k : K) . |k - œà(k)| ‚â§ Œµ   // since K ‚äÇ U, H_U moves pts by ‚â§ Œµ
      
      HAVE œà ‚àò œÜ ‚âÉ Id_M by s ‚Ü¶ H_M(s, œÜ(-)) for s ‚àà [0,1]
           œÜ ‚àò œà ‚âÉ Id_K by s ‚Ü¶ H_K(s, œà(-)) for s ‚àà [0,1]
        
      THUS M ‚âÉ[Œµ] K. Apply Stability Thm to get the result.
    }
  }
  
  PROOFS {  
    THEOREM PHTGluing {
      FORALL (M : Shape) (U : List[Shape]) . FiniteCover(U)(M) =>
        ƒåechDescent(PHTSheaf(M))(U)  
        
      PROOF {
        SUFFICES TO SHOW the following square is homotopy cartesian:
        
          PHTSheaf(M)(U)             -> holim[ ‚äï PHTSheaf(N)(U) | N ‚àà U ]
                        restriction |                          | restriction  
          PHTSheaf(M)(U ‚ãÇ Direction) -> holim[ ‚äï PHTSheaf(N)(U ‚ãÇ Direction) | N ‚àà U ]            
        
        BY repeated application of Mayer-Vietoris and Seifert-van Kampen.
      }
    }
    
    THEOREM PolyhedronNerve {  
      FORALL (M : Shape) . IsPolyhedron(M) => FORALL (n : N) .
        PHTSheaf(M)^n ‚âÉ H‚Åø[...]   -- statement from axiom
        
      PROOF {
        LET T : List[Shape] = Triangulation(M)        
        WE HAVE FiniteCover(T)(M) BY def of triangulation
        
        LET E¬π_*, E¬≤_* = spectral sequence of PHTSheaf(M) w.r.t. T
        
        HAVE E¬π_pq = ‚äï_{I ‚äÇ {0..k}, |I|=p+1} Hq(PHTSheaf(M_I))
             E¬≤_pq = Hp[q ‚Ü¶ ‚äï_{I ‚äÇ {0..k}, |I|=p+1} PHTSheaf(M_I)^q]
          BY ƒåechDescent(PHTSheaf(M))(T) and def. of ƒåech cochain complex.
          
        FORALL (p > 0) (q > 0) (I : {0..k}^(p+1)) . Hq(PHTSheaf(M_I)) = 0 
          BY contractibility of M_I
        
        THUS E¬≤_pq = E^‚àû_pq for p,q > 0. Spectral sequence collapses.  
        
        HENCE PHTSheaf(M)^n ‚âÉ Hn[p ‚Ü¶ ‚äï_{I ‚äÇ {0..k}, |I|=p+1} PHTSheaf(M_I)‚Å∞]
      }
    }
  }
}