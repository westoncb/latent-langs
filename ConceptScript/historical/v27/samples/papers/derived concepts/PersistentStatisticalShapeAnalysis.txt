CONCEPT PersistentStatisticalShapeAnalysis {
  NOTATION {
    ğ’® = {S_i} = Collection of shapes
    Î¼_ğ’® = FrÃ©chet mean of ğ’®
    Î£_ğ’® = FrÃ©chet covariance of ğ’®
    T_Î¼ğ’® = Tangent space to shape space at Î¼
    exp_Î¼ : T_Î¼ğ’® â†’ ğ’® = Exponential map  
    log_Î¼ : ğ’® â†’ T_Î¼ğ’® = Log map
    N(Î¼,Î£) = Gaussian on T_Î¼ğ’® with mean Î¼, covariance Î£
  }

  LANGUAGE {
    TYPE Shape = Constructible subset of â„^d
    TYPE ShapeCollection = Finite set of shapes
    TYPE ShapeSpace = Metric space of shapes with d_I
    TYPE PHTSpace = Space of PHTs with interleaving distance
    TYPE Mean = Shape
    TYPE Covariance = Positive-definite operator on T_Î¼ğ’®
    TYPE GaussianProcess = Stochastic process N(Î¼_ğ’®,Î£_ğ’®) on ğ’®

    FUNC FrechetMean(ğ’®: ShapeCollection): Mean = 
      argmin_{S âˆˆ ğ’®} âˆ‘_{S_i âˆˆ ğ’®} d_I(S, S_i)^2

    FUNC FrechetCovariance(ğ’®: ShapeCollection, Î¼_ğ’®: Mean): Covariance =
      âˆ‘_{S_i âˆˆ ğ’®} log_Î¼(S_i) âŠ— log_Î¼(S_i) / |ğ’®|

    FUNC ExpMap(v: T_Î¼ğ’®, Î¼: Mean): Shape = 
      Geodesic(Î¼, v) = Î³_Î¼^v(1) 

    FUNC LogMap(S: Shape, Î¼: Mean): T_Î¼ğ’® =
      v such that Î³_Î¼^v(1) = S

    FUNC SampleGP(GP: GaussianProcess, n: Int): ShapeCollection =
      {S_i = exp_Î¼(v_i) | v_i ~ N(0,Î£_ğ’®), i=1..n}  
  }

  STRUCTURES {
    STRUCTURE StatisticalShapeModel {
      FIELD Î¼: Mean
      FIELD Î£: Covariance
      FIELD GP: GaussianProcess = N(Î¼,Î£)

      COMPUTE FitToData(ğ’®: ShapeCollection): StatisticalShapeModel = {
        Î¼ := FrechetMean(ğ’®)
        Î£ := FrechetCovariance(ğ’®, Î¼)
        GP := N(Î¼,Î£)
        RETURN StatisticalShapeModel{Î¼,Î£,GP}
      }

      COMPUTE Sample(n: Int): ShapeCollection =
        SampleGP(SELF.GP, n)

      COMPUTE Likelihood(S: Shape): Real =
        PDF(SELF.GP, LogMap(S, SELF.Î¼))
    }
  }

  TRANSFORMERS {
    REWRITE FrechetMeanViaPHT: 
      FrechetMean(ğ’®) â‰ˆ argmin_{S âˆˆ ğ’®} âˆ‘_{S_i âˆˆ ğ’®} d_I(PHT(S), PHT(S_i))^2
      
    REWRITE FrechetCovarianceViaPHT:
      FrechetCovariance(ğ’®, Î¼_ğ’®) â‰ˆ âˆ‘_{S_i âˆˆ ğ’®} log_Î¼(PHT(S_i)) âŠ— log_Î¼(PHT(S_i)) / |ğ’®|
      WHERE log_Î¼(PHT(S_i)) := v such that exp_Î¼(v) â‰ˆ PHT(S_i)

    SIMPLIFY ExpMapViaPHT: 
      exp_Î¼(v) â‰ˆ PHT^(-1)(ShiftPHT(PHT(Î¼),v))
      WHERE ShiftPHT(â„±,v)(x,t) := â„±(x,t-âŸ¨v,xâŸ©)

    SIMPLIFY LogMapViaPHT:
      log_Î¼(S) â‰ˆ v such that ShiftPHT(PHT(Î¼),v) â‰ˆ PHT(S)
  }

  PROOFS {
    PROOF FrechetMeanConsistency: 
      lim_{|ğ’®|â†’âˆ} FrechetMean(ğ’®) = Î¼_ğ’® a.s. if S_i ~ N(Î¼_ğ’®,Î£_ğ’®) i.i.d.
    {
      DEFINE empirical FrÃ©chet functional:
        F_ğ’®(S) := (1/|ğ’®|) âˆ‘_{S_i âˆˆ ğ’®} d_I(S, S_i)^2
        
      OBSERVE that minimizers of F_ğ’® are empirical FrÃ©chet means:
        Î¼Ì‚_ğ’® = argmin F_ğ’® = FrechetMean(ğ’®)
        
      DEFINE population FrÃ©chet functional: 
        F(S) := ğ”¼[d_I(S,S_i)^2], S_i ~ N(Î¼_ğ’®,Î£_ğ’®)
        
      OBSERVE that minimizer of F is population FrÃ©chet mean:
        Î¼_ğ’® = argmin F
        
      F_ğ’® â†’ F uniformly as |ğ’®|â†’âˆ by law of large numbers
      
      â‡’ Î¼Ì‚_ğ’® â†’ Î¼_ğ’® by argmin continuous mapping theorem
    }

    PROOF FrechetCovarianceConsistency:
      lim_{|ğ’®|â†’âˆ} FrechetCovariance(ğ’®,Î¼Ì‚_ğ’®) = Î£_ğ’® a.s. if S_i ~ N(Î¼_ğ’®,Î£_ğ’®) i.i.d.  
    {
      DEFINE empirical covariance:
        Î£Ì‚_ğ’® := FrechetCovariance(ğ’®, Î¼Ì‚_ğ’®) 
             = (1/|ğ’®|) âˆ‘_i log_Î¼Ì‚(S_i) âŠ— log_Î¼Ì‚(S_i)
             
      log_Î¼Ì‚(S_i) â†’ log_Î¼(S_i) as Î¼Ì‚_ğ’® â†’ Î¼_ğ’® by continuity of log
      
      â‡’ Î£Ì‚_ğ’® â†’ ğ”¼[log_Î¼(S_i) âŠ— log_Î¼(S_i)], S_i ~ N(Î¼_ğ’®,Î£_ğ’®)
            = Î£_ğ’® by definition
    }
  }

  EXAMPLES {
    EXAMPLE DigitShapes {
      DEFINE ğ’® = {S_i} = 1000 images of handwritten '3' digits
      DEFINE Î¼_ğ’® = FrechetMean(ğ’®)
      DEFINE Î£_ğ’® = FrechetCovariance(ğ’®, Î¼_ğ’®)
      DEFINE GP = GaussianProcess{Î¼_ğ’®, Î£_ğ’®}

      SAMPLE S_new ~ GP 
      ASSERT S_new looks like a valid '3'

      SAMPLE S_anomaly ~ Uniform(â„^{256x256})
      ASSERT Likelihood(GP, S_anomaly) â‰ˆ 0
    }

    EXAMPLE ToothShapes {
      DEFINE ğ’® = {S_i} = 100 CT scans of mandibular molars
      DEFINE Î¼_ğ’® = FrechetMean(ğ’®)
      DEFINE Î£_ğ’® = FrechetCovariance(ğ’®, Î¼_ğ’®)  
      DEFINE GP = GaussianProcess{Î¼_ğ’®, Î£_ğ’®}

      DEFINE S_patient = Segmented molar from new patient
      DEFINE S_reconstruction = ExpMap(LogMap(S_patient, Î¼_ğ’®), Î¼_ğ’®)

      ASSERT S_reconstruction captures key features of S_patient
      ASSERT S_reconstruction more regular than S_patient
    }
  }
}