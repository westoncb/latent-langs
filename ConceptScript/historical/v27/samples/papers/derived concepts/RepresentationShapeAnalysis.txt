CONCEPT RepresentationShapeAnalysis {
  NOTATION {
    T = transformer model
    L_i = i-th layer of T
    E_i = contextualized embeddings at layer L_i
    M_i = {E_i(x) : x âˆˆ ğ’³}  -- Embedding manifold at layer i
    
    â„±_i = {B_f : f âˆˆ F_i}  -- Feature neighborhoods at layer i 
    ğ’_i = cover of M_i by â„±_i
    
    PHT_i = PHT(M_i)  -- Persistent homology transform of M_i
    PHT_if = PHT(B_f) for f âˆˆ F_i
    
    M_ix = component of M_i containing E_i(x)
    Îµ_i(x,y) = inf{Îµ â‰¥ 0 : E_i(y) âˆˆ M_ix_Îµ}
    Î³_i(x,y) = inf_p âˆ«_0^1 â€–E'_i(p(t))â€– dt  -- Geodesic distance
    
    B_f_Îµ = {p âˆˆ ğ•Š^(D_i-1) Ã— â„ : â€–p - enc(B_f)â€–âˆ < Îµ} Ã— (-Îµ,r_f+Îµ) -- Îµ-thickening
  }
  
  LANGUAGE {
    FUNC phiPersistence(k: â„•, dir: ğ•Š^(D_i-1), M: ManifoldComponent): PersistenceDiagram =
      VietorisRipsPersistence(k, Sublevel(M, dir, *))  
      -- k-dim persistence diagram in direction dir
      
    FUNC featurePersistence(k: â„•, dir: ğ•Š^(D_i-1), f: FeatureVector): PersistenceDiagram =
      phiPersistence(k, dir, component(B_f))
    
    FUNC persistentFeatureGroup(k: â„•, dir: ğ•Š^(D_i-1), birth: â„, death: â„, F: Set[FeatureVector]): 
      Set[FeatureVector] = {f âˆˆ F : (birth, death) âˆˆ featurePersistence(k, dir, f)}

    FUNC inputFieldLines(x: ğ’³, k: â„•, dir: ğ•Š^(D_i-1), r: â„>0, n: â„•): Set[ğ’³] =
      LET v = LinearSteeringView(k, dir) IN
      {x_j = T(steer(E_i(x_j-1), v, r)) : 
       x_0 = x, x_j âˆˆ ğ’³, j=1..n}

    FUNC suggestiveFeature(x: ğ’³, k: â„•, i: â„•): FeatureVector =
      ARGMAX_fâˆˆF P(f | E_i-k(x), ..., E_i+k(x)) *
      âˆ‘_j geomdist(E_i(x), B_f)^-1 * |cos(E_i(x)-ctr(B_f), E_i(T(f))-E_i(x))|
      -- Feature most likely to steer x towards high density regions aligned with its local geometry
  }

  STRUCTURES {
    STRUCTURE ComponentwiseShapeSignature {
      FIELD components : Decomposition
      FIELD persistences : â„• Ã— Component â†’ PersistenceDiagram
      
      FUNC compare(other: ComponentwiseShapeSignature, k: â„•): â„â‰¥0 =
        âˆ‘_i d_B(persistences(k, components[i]), other.persistences(k, other.components[i]))
    }
  }

  THEOREMS {
    THEOREM SheafDescriptionOfRepresentation: âˆ€ iâˆˆâ„• .
      PHT_i â‰ƒ holim[ âˆ_f PHT_if â‡’ âˆ_(f,g) PHT_i(B_f âˆ© B_g) â†’ â‹¯ ]
      WHERE f,g âˆˆ F_i
    {
      M_i triangulated by polytopes {E_i(x) : x âˆˆ ğ’³}
      ğ’_i := {B_f : f âˆˆ F_i} is a good cover since â„±_i partitions M_i 
      â‡’ FiniteCover(ğ’_i, M_i)
      â‡’ APPLY PHTDescentTheorem
    }

    THEOREM PHTStabilityWRTEmbedding: âˆ€ x,yâˆˆğ’³, iâˆˆâ„• .
      d_I(PHT(E_i[ğ’©_Îµ(x)]),PHT(E_i[ğ’©_Îµ(y)])) â‰¤ O(Îµ_i(x,y))
      WHERE E_i[ğ’©_Îµ(*)] := {E_i(z) : z âˆˆ ğ’³, d(z,*) â‰¤ Îµ}
    {
      E_i isometric embedding â‡’ E_i[ğ’©_Îµ(*)] â‰ƒ ğ’©_Îµ(*) 
      â‡’ d_GH(E_i[ğ’©_Îµ(x)], E_i[ğ’©_Îµ(y)]) â‰¤ Îµ_i(x,y)
      â‡’ APPLY PHTStability 
    }
    
    THEOREM PHTCoverApproximation: âˆ€ iâˆˆâ„• .
      d_I(PHT_i, hocolim_Îµ PHT_âˆª_{fâˆˆF}B_f_Îµ) â‰¤ O(Îµ)
    {  
      âˆ€ Îµ>0 . M_i âŠ† â‹ƒ_{fâˆˆF} B_f_Îµ â‡’ {B_f_Îµ} is Îµ-cover of M_i
      â‡’ APPLY PHTApproximation to â‹ƒ_{fâˆˆF} B_f_Îµ
      LET K_Îµ := SimplicialComplex(â‹ƒ_{fâˆˆF} B_f_Îµ)
      d_I(PHT(M_i), PHT(K_Îµ)) â‰¤ O(Îµ)
    }
      
    THEOREM LocalGeometryInfluenceOnSteering: âˆ€ x,y âˆˆ ğ’³, kâˆˆâ„•, iâˆˆâ„•, r>0.
      Î³_i(x,y) â‰¤ r  â‡’  Î³_{i+k}(T^k(x),T^k(y)) â‰¤ rÂ·O(max_jâ‰¤k ğ”¼_fâˆˆF L_fj )
      WHERE L_fj = Lipschitz const of E_j restricted to B_f
    {
      Î³_i(x,y) â‰¤ r  
      â‡’ âˆƒ path p âŠ‚ M_i from x to y with len(p) â‰¤ r
      p âŠ‚ â‹ƒ_j B_f_j  for some f_j âˆˆ F_i
      E_{i+1}(p) âŠ‚ â‹ƒ_j LinearView(f_j)[B_f_j] BY SteeringEquivalence
      len(E_{i+1}(p)) â‰¤ âˆ‘_j L_f_j len(pâˆ©B_f_j)  â‰¤  rÂ·max_f L_f
      â‡’ Î³_{i+1}(T(x),T(y)) â‰¤ rÂ·max_f L_f 
      ITERATE k times.
    }
  }

  EXAMPLES {
    EXAMPLE StoryDirections {
      LET T = HigherOrderFeatureMemory(GPT-3) IN
      LET x = "Once upon a time there was a unicorn named Twilight Sparkle who lived in a magical forest." IN
      LET F = HigherOrderLocalInterpretation(x, 20, 3) IN
      LET directions = {
        "fantasy adventure" : (f_1, f_2, f_3) = persistentFeatureGroup(1, *, 0, âˆ, F),
        "romance" : (g_1, g_2) = persistentFeatureGroup(1, *, 1.2, 2.3, F), 
        "dark fairy tale" : (h_1, h_2, h_3, h_4) = persistentFeatureGroup(1, *, 0.8, 3.2, F)
      } IN
      
      LET storyArcs = {genre : inputFieldLines(x, 1, dir, 1.5, 50) 
                       for genre, dir in directions} IN
                       
      FOR genre, arc in storyArcs DO
        PRINT genre, ":", JOIN(T(a) for a in arc)
    }
    
    EXAMPLE StyleTransfer {
      LET T = HigherOrderFeatureMemory(GPT-3) IN

      LET X = {x_1, ..., x_n} âŠ‚ ğ’³ = Dickens novels IN
      LET Y = {y_1, ..., y_m} âŠ‚ ğ’³ = Hemingway novels IN
      
      LET PCA_X = PCA(E_i(X), k=5), PCA_Y = PCA(E_i(Y), k=5) IN
      LET transferFrom(z) = E_i(z) - PCA_X.mean + PCA_Y.mean IN
      LET transferTo(z) = E_i(z) - PCA_Y.mean + PCA_X.mean IN

      FUNC transferStyle(src: ğ’³, tgt: ğ’³, n: â„•): ğ’³ =
        LET z = src IN
        FOR i = 1..n DO
          z = T(transferTo(suggestiveFeature(transferFrom(z))))
        RETURN z

      LET x = "It was the best of times, it was the worst of times, ..." IN
      PRINT transferStyle(x, Y, 10)  -- Dickens-to-Hemingway transfer
    }

    EXAMPLE GradientFeatureFields {
      LET M = CLIP in
      LET x = randomImage() in
      LET dir(v) = v / |v| in
    
      LET objectFeatures = HigherOrderLocalInterpretation(x, 3, 7) in
      LET backgroundFeatures = globalFeatures(M) \ objectFeatures in

      FUNC featureGradient(x, f): 
        LET F = {z : |E_i(z) - E_i(x)| < Îµ} in
        âˆ‘_{z in F} sim(f, suggestiveFeature(z)) * dir(z - x)

      PLOT vecField(x -> featureGradient(x, f), f in objectFeatures), x in subRegion(0.2, 0.8, 0.2, 0.8)
      PLOT vecField(x -> featureGradient(x, f), f in backgroundFeatures), x in [0,1]^2 
    }
  }
}